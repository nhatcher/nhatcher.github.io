<!doctype html><html lang=en data-theme><head>
<title> Nicolás Hatcher | A CTO playbook on a shoestring </title><meta charset=utf-8><meta name=generator content="Hugo 0.119.0"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name=description content="Software developer by trade, physicist by soul">
<link rel=stylesheet href=https://www.nhatcher.com/css/style.min.0c643de4008adca329f7a2d616ce308cca99d4ef45e4cca307323e7857910194.css integrity="sha256-DGQ95ACK3KMp96LWFs4wjMqZ1O9F5MyjBzI+eFeRAZQ=" crossorigin=anonymous type=text/css>
<link rel=stylesheet href=https://www.nhatcher.com/css/markupHighlight.min.f798cbda9aaa38f89eb38be6414bd082cfd71a6780375cbf67b6d2fb2b96491e.css integrity="sha256-95jL2pqqOPies4vmQUvQgs/XGmeAN1y/Z7bS+yuWSR4=" crossorigin=anonymous type=text/css>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA==" crossorigin=anonymous>
<link rel="shortcut icon" href=https://www.nhatcher.com/favicons/favicon.ico type=image/x-icon>
<link rel=apple-touch-icon sizes=180x180 href=https://www.nhatcher.com/favicons/apple-touch-icon.png>
<link rel=icon type=image/png sizes=32x32 href=https://www.nhatcher.com/favicons/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=https://www.nhatcher.com/favicons/favicon-16x16.png>
<link rel=canonical href=https://www.nhatcher.com/post/a-cto-on-a-shoestring/>
<script type=text/javascript src=https://www.nhatcher.com/js/anatole-header.min.df804b63b5bd8474ea0756ea874bc8f1e92552708cc6ea43aa0d76981dc419f9.js integrity="sha256-34BLY7W9hHTqB1bqh0vI8eklUnCMxupDqg12mB3EGfk=" crossorigin=anonymous></script>
<script type=text/javascript src=https://www.nhatcher.com/js/anatole-theme-switcher.min.3829579c725749492568b0e6fa9da3012a7fc37fd291b4fd79e33c1df5d8a34a.js integrity="sha256-OClXnHJXSUklaLDm+p2jASp/w3/SkbT9eeM8HfXYo0o=" crossorigin=anonymous></script>
<meta name=twitter:card content="summary">
<meta name=twitter:title content="A CTO playbook on a shoestring">
<meta name=twitter:description content="Let&rsquo;s create a web application together!
This document is continuously updated.">
</head><body><div class="sidebar .">
<div class=logo-title>
<div class=title>
<img src=https://www.nhatcher.com/images/profile.jpg alt="profile picture">
<h3 title><a href=/>I'm Nicolás Hatcher</a></h3><div class=description>
<p>Software developer by trade, physicist by soul</p></div></div></div><ul class=social-links>
<li>
<a href="https://arxiv.org/search/?searchtype=author&amp;query=Hatcher%2C+N" rel=me aria-label=Publications>
<i class="fas fa-file-alt fa-2x" aria-hidden=true></i>
</a>
</li><li>
<a href=https://github.com/nhatcher/ rel=me aria-label=GitHub>
<i class="fab fa-github fa-2x" aria-hidden=true></i>
</a>
</li><li>
<a href=https://www.instagram.com/theuniverse.today rel=me aria-label=instagram>
<i class="fab fa-instagram fa-2x" aria-hidden=true></i>
</a>
</li><li>
<a href=mailto:nicolas@theuniverse.today rel=me aria-label=e-mail>
<i class="fas fa-envelope fa-2x" aria-hidden=true></i>
</a>
</li></ul><div class=footer>
<div class=by_farbox>&copy; Nicolás Hatcher 2023 </div></div></div><div class=main>
<div class="page-top .">
<a role=button class=navbar-burger data-target=navMenu aria-label=menu aria-expanded=false>
<span aria-hidden=true></span>
<span aria-hidden=true></span>
<span aria-hidden=true></span>
</a>
<ul class=nav id=navMenu>
<li><a href=/ title>Home</a></li><li><a href=/post/ title>Posts</a></li><li><a href=/about/ title>About</a></li><li class=theme-switch-item>
<a class=theme-switch title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i>
</a>
</li></ul></div><div class=autopagerize_page_element>
<div class=content>
<div class="post .">
<div class=post-content>
<div class=post-title>
<h3>A CTO playbook on a shoestring</h3><div class=info>
<em class="fas fa-calendar-day"></em>
<span class=date> Sun, Oct 15, 2023
</span>
<em class="fas fa-stopwatch"></em>
<span class=reading-time>42-minute read</span>
</div></div><p>Let&rsquo;s create a web application together!</p><p>This document is continuously updated. <strong>Latest revision: October 19, 2023</strong></p><p>All the code is in <a href=https://github.com/nhatcher/users-template>github</a>.</p><p>In this blog post you are going to learn how to setup and deploy a simple web application with modern best programming practices and all the bells and whistles you need to grow the app from zero to a few hundred users.</p><p>You may find that certain aspects require customization to align with your preferences. You might want to use a different platform to read your logs, opt for NGINX over Caddy, run your Django code with Daphne instead of Gunicorn, decide GitHub is not good for you, or use a different email provider or host provider or get the domain name from a different name registrar. You will still be able to use this with minimal modifications. Changing Django and python for a different framework or programming language will require more changes but the fundamental insights provided in this post will hopefully remain valuable. Using <a href=https://laravel.com/>Lavarel</a>, <a href=https://rubyonrails.org/>Ruby on Rails</a> or plain <a href=https://go.dev/>go</a> should pose no big challenges to the reader.</p><p>This should not only be regarded as a tutorial on how to setup and install everything but as a guide on how to build a modern web application. Using the code provided and following this guide might get you up and running in a matter of hours instead of days or even weeks, but you should be prepared to do some sleuthing.</p><p>The guide is intended for a small team, maybe just one single person. If your team is larger than five people this guide might still work but might fall short in some respects. I am assuming you have almost no cash to dedicate to this project, we are going to do this on a shoestring. With all this in place if you make the project grow from a solo developer and no users to a few hundred users and 5 developer you will very easily upgrade the tools and hardware. I am assuming also you have some background in programming and you are comfortable in a Linux terminal. If you are not you really need a more technical partner that will help you with that. You will also not learn Django or Python here although you should be ok if you know just some Python and are willing to dedicate some time to go through the <a href=https://docs.djangoproject.com/en/>Django documentation</a></p><p>Although I am guiding you through the cheapest possible option, as soon as you start getting customers you should consider investing in infrastructure. Maybe you will need a separate database server o a more performant server or paying for some of the services you are using.</p><p>This is not the only way to setup a server. There are tons of other ways of doing this. Some might want to use <a href=https://www.heroku.com/>Heroku</a> or <a href=https://fly.io/>Fly.io</a> or a completely managed <a href=https://www.cloudron.io/>Cloudron</a>. There are of course the big enterprise solutions like <a href=https://cloud.google.com/>Google Cloud</a>, <a href=https://aws.amazon.com/>AWS</a> or <a href=https://azure.microsoft.com/>Microsoft Azure</a></p><p>Lastly we will not be setting the frontend here. All we are going to do here is completely frontend agnostic. You could do the whole frontend in vanilla HTML, CSS and JavaScript or use any modern framework like React and TypeScript.</p><p>After having setup toy webapps following similar patterns, the idea of this project came when I joined forces with Lu Bertolucci to work on his project <a href=https://www.feirou.org/>Feirou</a>. As I had some available time in my hands I thought this was a good moment to do this right.</p><p>Many of the things that I will recommend here I learn from my coworkers during the past 14 years! I also have them to thank.</p><p>A brief note on nomenclature. I will assume that your username is &lsquo;jsmith&rsquo;, that your local&rsquo;s name computer is &rsquo;local&rsquo;, your remote name computer is &lsquo;remote&rsquo;, the name of the domain you bought is &rsquo;example.com&rsquo; and that the ip in your VPS is &lsquo;93.184.216.34&rsquo;.
If you are following in Linux or Mac you will have no issues. If you are following in a Windows machine and are working in the WSL it should be pretty straightforward. Otherwise you might need to tweak some commands for your own environment and OS. When you see a command like:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>root@remote# apt install failban
</span></span></code></pre></div><p>means that you are running this command as root in the remote machine. And the remote folder is not important. Note that you know that it is a root user because the prompt ends with &lsquo;#&rsquo; and not with &lsquo;$&rsquo;. With this provisions I hope it is clear where are you running what command.</p><p>Finally, I will check links and versions. I will try not to link to third party blogs but prefer tools documentation. That said, links might be broken. I will always try to provide information about the link so you can search the internet easily.</p><h2 id=technology-stack-and-options>Technology stack and options</h2><p>This is a quick survey of the technologies we are using, why I chose them and the alternatives.</p><ol>
<li>
<p><strong>Web server: Caddy</strong> server. Runner up NGINX.</p><p>We picked Caddy vs NGINX, because Caddy is even simpler to configure than NGINX. Caddy is just one binary, you can run it in your local machine and it has https build in. I am a big fan. NGINX is also great, you can&rsquo;t go wrong with any of them.</p><p>Apache is still a valid option.</p></li><li>
<p><strong>Framework: Python + Django.</strong> No runner up, or just too many of them.</p><p>Most of the technology, advices and best practices are fairly independent from Python and Django so you could easily adapt this to <em>Nodejs + Express</em>, for instance. If you are comfortable with Python but you don&rsquo;t want to use Django, you might use Flask.</p><p>Some other programming languages like Java (and the JVM languages) or C# have it&rsquo;s own ecosystem and will have implications on what other tools you use.</p></li><li>
<p><strong>Application server: Gunicorn.</strong> Runner up Daphne.</p><p>Gunicorn follows the WSGI server protocol while Daphne follows ASGI. This basically means that Gunicorn is a blocking synchronous server and Daphne is asynchronous.</p><p>We went for Gunicorn for simplicity. Upgrading to a ASGI compliant server should be an easy job. That&rsquo;s tomorrows problem.</p><p>Other options include uWSGI, Uvicorn (ASGI), Hypercorn (ASGI). See the <a href=https://docs.djangoproject.com/en/4.2/howto/deployment/>Django documentation</a></p></li><li>
<p><strong>Database: PostgreSQL.</strong> Runner up MySQL or SQLite</p><p>If you have a reason why not to use PostgreSQL go ahead and do that. Note that we are still using SQLite during development.</p></li><li>
<p><strong>Host provider: DigitalOcean.</strong> Runner up Scaleway or Oracle Cloud (free!)</p><p>There are a lots of great options here. We went with DigitalOcean because it is cheap and an excellent service. Second to none.</p></li><li>
<p><strong>Domain registrar: Namecheap.</strong> Runner up GoDaddy</p><p>Again there are tons of options here. Take into account that not all name registrars offer the same feature. Exercise caution when going for a less known one. Also keep an eye for the renewal costs.</p></li><li>
<p><strong>Email provider: Zoho.</strong> Runner up Google (paid service).</p><p>Other options <a href=https://www.migadu.com/>https://www.migadu.com/</a> for 20€ a year or <a href=https://proton.me/>prontonmail</a> for 50€/year for 10 email addresses. Fastmail has a similar price to Google, <a href=https://tutanota.com/pricing>tutanota</a> has also a very generous offer and might even be for free if you are doing <a href=https://tutanota.com/discount>open source</a>.
A completely different way would be to self host. I don&rsquo;t recommend that, although you will have infinite amount of email addresses and will be in control of everything you might find that many of your emails are not being delivered correctly. As of today email is a sort of oligopoly and you might end up in an unlucky situation in which all your outgoing email is being blocked. There are people with notable success here, so it is definitely possible. If you are going down that route consider using <a href=https://www.cloudron.io/>Cloudron</a> with a DigitalOcean droplet.</p></li><li>
<p><strong>Logs: Sentry.</strong> Runner up Loggly</p><p>I don&rsquo;t have a ton of experience here. Other two options are <a href=https://newrelic.com/>new relic</a> and <a href=https://www.loggly.com/>Loggly</a>.
I chose Sentry for simplicity, it would be very easy to switch to another platform. Your logging platform should be mostly unintrusive.</p></li><li>
<p><strong>Wireframes: <a href=https://www.drawio.com/>Draw.io</a>.</strong> Runner up Figma</p><p>Although this blog post is not about the frontend, it helps a lot having the wireframes in place. Draw.io is a simple, free, well done tool useful in many contexts. One of the many things I learned from Stephen Grider.
Figma can also be used for wireframing. And also lots of other possibilities.</p></li><li>
<p><strong>GitHub</strong>. No runner up</p><p>There are alternatives out there like <a href=https://about.gitlab.com/>GitLab</a>, but I haven&rsquo;t used them. We are also using GitHub Actions as our test runner. Other options include <a href=https://circleci.com/>CircleCI</a>.</p></li><li>
<p><strong>Ubuntu Linux</strong>. No runner up</p><p>We will be deploying in an Ubuntu VPS. Any debian based system should work in a very similar way. The whole thing will work in any Linux system but you might have to change a few commands.</p></li></ol><h2 id=getting-a-domain-name-10-a-year>Getting a domain name (~10€ a year)</h2><p>You can buy a domain name from places like <a href=https://www.namecheap.com/>Namecheap</a>, but there are many other vendors. Just make sure that they only sell you the domain name and nothing else. It should cost you around 10€ a year. But you can find really cheap domain names for a year you can get for your testing. Beware of not renewing them, those cost go up and add!</p><h2 id=getting-an-email-account>Getting an email account</h2><p>There are several paid vendors like Google. But we will use <a href=https://www.zoho.com/mail/zohomail-pricing.html>Zoho</a> that for now is free. Scroll down to the &ldquo;forever free plan&rdquo;. You can use one provider now and move to a different one in the future. Because you own the domain name you will not need to change email addresses. The only problem you might have to deal with is exporting from Zoho and importing them again in the new platform if you ever want to do that.</p><p>Zoho has a nice web service and apps for Android and iOS to read and send your email from the phone.</p><p>To setup your email, you will need to follow the steps in one of these guides, <a href=https://www.namecheap.com/support/knowledgebase/article.aspx/9758/2208/how-to-set-up-zoho-email-for-my-domain/>Namecheap</a> or <a href=https://www.zoho.com/mail/help/adminconsole/namecheap.html>Zoho</a>.</p><p>With this done you should be able to send a receive emails with your new fancy email address. You can up to 5 email accounts, for instance <code>hello@example.com</code> and <code>support@example.com</code> but you can configure zoho to get all emails on <code>hello@example.com</code>. You can also now send emails programmatically.</p><p>Now you should be able to send an email programmatically:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>smtplib</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>email.mime.text</span> <span class=kn>import</span> <span class=n>MIMEText</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>email.header</span> <span class=kn>import</span> <span class=n>Header</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>email.utils</span> <span class=kn>import</span> <span class=n>formataddr</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Configure in zoho</span>
</span></span><span class=line><span class=cl><span class=n>password</span> <span class=o>=</span> <span class=s2>&#34;my secret password&#34;</span>
</span></span><span class=line><span class=cl><span class=n>domain</span> <span class=o>=</span> <span class=s2>&#34;example.com&#34;</span>
</span></span><span class=line><span class=cl><span class=n>sender_user</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;support@</span><span class=si>{</span><span class=n>domain</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>send_email</span><span class=p>(</span><span class=n>email</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># Define to/from</span>
</span></span><span class=line><span class=cl>    <span class=n>subject</span> <span class=o>=</span> <span class=s2>&#34;First email ever!&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>sender_title</span> <span class=o>=</span> <span class=s2>&#34;Example App Support&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Create message</span>
</span></span><span class=line><span class=cl>    <span class=n>msg</span> <span class=o>=</span> <span class=n>MIMEText</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;Hello world!&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;plain&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;utf-8&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>msg</span><span class=p>[</span><span class=s2>&#34;Subject&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=n>Header</span><span class=p>(</span><span class=n>subject</span><span class=p>,</span> <span class=s2>&#34;utf-8&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>msg</span><span class=p>[</span><span class=s2>&#34;From&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=n>formataddr</span><span class=p>((</span><span class=nb>str</span><span class=p>(</span><span class=n>Header</span><span class=p>(</span><span class=n>sender_title</span><span class=p>,</span> <span class=s2>&#34;utf-8&#34;</span><span class=p>)),</span> <span class=n>sender_user</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>msg</span><span class=p>[</span><span class=s2>&#34;To&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=n>email</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Create server object with SSL option</span>
</span></span><span class=line><span class=cl>    <span class=n>server</span> <span class=o>=</span> <span class=n>smtplib</span><span class=o>.</span><span class=n>SMTP_SSL</span><span class=p>(</span><span class=s2>&#34;smtp.zoho.com&#34;</span><span class=p>,</span> <span class=mi>465</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Perform operations via server</span>
</span></span><span class=line><span class=cl>    <span class=n>server</span><span class=o>.</span><span class=n>login</span><span class=p>(</span><span class=n>sender_user</span><span class=p>,</span> <span class=n>password</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>server</span><span class=o>.</span><span class=n>sendmail</span><span class=p>(</span><span class=n>sender_user</span><span class=p>,</span> <span class=p>[</span><span class=n>email</span><span class=p>],</span> <span class=n>msg</span><span class=o>.</span><span class=n>as_string</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>server</span><span class=o>.</span><span class=n>quit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># who do you want to send the email to:</span>
</span></span><span class=line><span class=cl>    <span class=n>to_address</span> <span class=o>=</span> <span class=s2>&#34;jsmith@test.com&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>send_email</span><span class=p>(</span><span class=n>to_address</span><span class=p>)</span>
</span></span></code></pre></div><h2 id=server-provision-and-setup-5-a-month>Server provision and setup (~5€ a month)</h2><p>This is by far the most complicated bit. But you only have to do it once.</p><p>Before even getting a VPS you need a pair of ssh keys. You probably have already done it for <a href=https://docs.github.com/en/authentication/connecting-to-github-with-ssh/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent>GitHub</a>.</p><p>Your cloud provider will probably let you <a href=https://docs.digitalocean.com/products/droplets/how-to/add-ssh-keys/to-team/>upload your public key</a> so that every new VPS will have the ssh key installed.</p><p>I am using an instance in <a href=https://www.digitalocean.com/>DigitalOcean</a> basic droplets that at the time of writing are advertised as 4$/month but because of billing issues turns out to be around 4.5€ a month. This is enough for our purposes.
Other options are <a href=https://www.scaleway.com/en/>Scaleway</a>, <a href=https://www.linode.com/>Linode</a>, <a href=https://www.hetzner.com/>Hetzner</a>, and many others. Most notably <a href=https://www.oracle.com/cloud/free/>Oracle Cloud</a> offers a forever free tier!</p><p>Once you have your own VPS the only important thing is that you have a set of two scripts:</p><ul>
<li><code>install.sh</code> that you need to run once when you provision the VPS.</li><li><code>deploy.sh</code> that you need to run every time you want to update your code.</li></ul><p>This section is just an explanation of what <a href=https://github.com/nhatcher/users-template/blob/main/deployment_scripts/install.sh><code>install.sh</code></a> does. Although I have used a bash script for both the install and deploy scripts, feel free to use something different like Python. A bash script of more than a hundred lines of code is rarely a good idea.</p><ol>
<li>Secure the server</li></ol><p>Log into the remote server. That is normally done by:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>jsmith@local:~/$ ssh root@93.184.216.34
</span></span></code></pre></div><p>Where <code>93.184.216.34</code> is just the example IP.</p><p>Install <code>fail2ban</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>root@remote# apt install fail2ban
</span></span></code></pre></div><p>Make sure you can only ssh with a key and not with a password. So <code>ssh root@93.184.216.34</code> only works form your computer with the private ssh key.</p><p>Note that playing with firewall is a little dangerous, not only you can expose your machine to the rest of the internet if you do something wrong, you can also you lock yourself out if you set the wrong rules. Some vendors give you a direct console access to your VPS and that will mitigate the issue. But if you don&rsquo;t have direct console access tread carefully. So read all the documentation first and apply the rules that are convenient only after understanding what you are doing.</p><p>A firewall is a piece if software, or hardware, that acts as security barrier monitoring and controlling incoming and outgoing network traffic based on a set of predefined rules or policies. The Linux kernel has a build in <a href=https://en.wikipedia.org/wiki/Netfilter>Netfilter</a> framework that we can control in userspace with a command-line utility, &lsquo;iptables&rsquo;, that allows you to configure and manage firewall rules and network packet filtering. In layperson terms this means that at the Operative System level we have a way to check all data coming in or going out of your computer.</p><p>Raw &lsquo;iptables&rsquo; commands are hard to understand, even for experts and there are other programs designed to generate this rules for you. A good example is the &lsquo;fail2ban&rsquo; command above. In Ubuntu system the program &lsquo;UFW&rsquo;, (the Uncomplicated FireWall) is widely used. The following will deny all incoming traffic and allow all outgoing, then allow all ssh, http and https. Hopefully it is self explanatory.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>root@remote# apt install ufw
</span></span><span class=line><span class=cl>root@remote# ufw disable
</span></span><span class=line><span class=cl>root@remote# ufw default deny incoming
</span></span><span class=line><span class=cl>root@remote# ufw default allow outgoing
</span></span><span class=line><span class=cl>root@remote# ufw allow ssh
</span></span><span class=line><span class=cl>root@remote# ufw allow http
</span></span><span class=line><span class=cl>root@remote# ufw allow https
</span></span><span class=line><span class=cl>root@remote# ufw enable
</span></span></code></pre></div><p>And if that worked 100% of the cases I wouldn&rsquo;t have had to tell you about &lsquo;iptables&rsquo; in the first place. If you are administrating a VPS chances are you will have to see the face of the tiger sooner rather than later.</p><p>If you can&rsquo;t use UFW a set of rules that works well for our purposes is:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1># Flush existing rules</span>
</span></span><span class=line><span class=cl>iptables -F
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Allow incoming SSH (port 22) traffic</span>
</span></span><span class=line><span class=cl>iptables -A INPUT -p tcp --dport <span class=m>22</span> -j ACCEPT
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Allow established connections</span>
</span></span><span class=line><span class=cl>iptables -A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Allow incoming HTTP (port 80) traffic</span>
</span></span><span class=line><span class=cl>iptables -A INPUT -p tcp --dport <span class=m>80</span> -j ACCEPT
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Allow incoming HTTPS (port 443) traffic</span>
</span></span><span class=line><span class=cl>iptables -A INPUT -p tcp --dport <span class=m>443</span> -j ACCEPT
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Allow loopback (localhost) traffic</span>
</span></span><span class=line><span class=cl>iptables -A INPUT -i lo -j ACCEPT
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Allow ICMP (ping) traffic</span>
</span></span><span class=line><span class=cl>iptables -A INPUT -p icmp --icmp-type echo-request -j ACCEPT
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Set the default policies to DROP (block all other incoming traffic)</span>
</span></span><span class=line><span class=cl>iptables -P INPUT DROP
</span></span><span class=line><span class=cl>iptables -P FORWARD DROP
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Allow all outgoing traffic</span>
</span></span><span class=line><span class=cl>iptables -P OUTPUT ACCEPT
</span></span></code></pre></div><p>You can run the commands one by one or run in in a file <code>firewall-setting.sh</code>.
If you want to make a backup of your current rules before you do your foolishness:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># iptables-save &gt; ~/iptables-rules
</span></span></code></pre></div><p>And to restore them:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># iptables-restore iptables-rules
</span></span></code></pre></div><p>You need to know that applying iptables rules are not persisted after boot. So if you do get locked out just reboot your VPS. There are several ways to persist the rules. Creating a system script like we have done for caddy and gunicorn is not a bad way:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[Unit] 
</span></span><span class=line><span class=cl>Description=runs iptables restore on boot
</span></span><span class=line><span class=cl>ConditionFileIsExecutable=/opt/util/restore-iptables.sh
</span></span><span class=line><span class=cl>After=network.target
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[Service]
</span></span><span class=line><span class=cl>Type=forking
</span></span><span class=line><span class=cl>ExecStart=/opt/util/restore-iptables.sh
</span></span><span class=line><span class=cl>start TimeoutSec=0
</span></span><span class=line><span class=cl>RemainAfterExit=yes
</span></span><span class=line><span class=cl>GuessMainPID=no
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[Install]
</span></span><span class=line><span class=cl>WantedBy=multi-user.target
</span></span></code></pre></div><p>And then the <code>restore-iptables.sh</code> script would be:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/sh
</span></span></span><span class=line><span class=cl><span class=cp></span>/usr/bin/flock /run/.iptables-restore /opt/util/iptables-restore /etc/iptables/rules.v4
</span></span></code></pre></div><p>Enough with the firewall. Create a user and add it to the sudoers list. Make sure you can ssh with that user and remove ssh root access to the machine.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>root@remote# adduser jsmith
</span></span></code></pre></div><p>Where &lsquo;jsmith&rsquo; is your username. Add it to the sudoers list:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>root@remote# usermod -aG sudo jsmith
</span></span></code></pre></div><p>As <code>jsmith</code> copy the contents of the root&rsquo;s <code>authorized_keys</code> file (usually at <code>/root/.ssh/authorized_keys</code>) to the username&rsquo;s <code>authorized_keys</code> file (<code>/home/username/.ssh/authorized_keys</code>). In a different terminal test that you can ssh as the new username:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>jsmith@local:~/ $ ssh jsmith@93.184.216.34
</span></span></code></pre></div><p>Once in the remote computer check that you can become a superuser by typing <code>sudo su</code> and entering your password. Now keep your password safe and delete the root&rsquo;s <code>authorized_keys</code> file.</p><p>Congratulations, you have secured your server. You should not be able to ssh as root anymore.</p><p>Now, there are still services running on your computer you might not be aware of. One of them is the OSI layer 3 echo ICMP server built in the operative system. For your laptop at home try:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>jsmith@local:~/ $ ping -c 5 example.com
</span></span><span class=line><span class=cl>PING example.com (93.184.216.34) 56(84) bytes of data.
</span></span><span class=line><span class=cl>64 bytes from example.com (93.184.216.34): icmp_seq=1 ttl=52 time=26.0 ms
</span></span><span class=line><span class=cl>64 bytes from example.com (93.184.216.34): icmp_seq=2 ttl=52 time=30.1 ms
</span></span><span class=line><span class=cl>64 bytes from example.com (93.184.216.34): icmp_seq=3 ttl=52 time=24.4 ms
</span></span><span class=line><span class=cl>64 bytes from example.com (93.184.216.34): icmp_seq=4 ttl=52 time=25.7 ms
</span></span><span class=line><span class=cl>64 bytes from example.com (93.184.216.34): icmp_seq=5 ttl=52 time=27.8 ms
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>--- example.com ping statistics ---
</span></span><span class=line><span class=cl>5 packets transmitted, 5 received, 0% packet loss, time 4006ms
</span></span><span class=line><span class=cl>rtt min/avg/max/mdev = 24.359/26.784/30.122/1.988 ms
</span></span></code></pre></div><p>This is helpful to test if your computer is up and the network is listening. Note that we have not allowed the service in the firewall, yet it is there running. This is telling you that a round trip time for ping request to your machine is around 26 milliseconds.</p><p>Your cloud provider might also feature some firewall settings. I don&rsquo;t think that setting a firewall both at the os level and at the cloud provider level would break anything but it&rsquo;s probably not a great idea since it might lead to difficult to debug issues. But you should go ahead and read about the firewall in your cloud provider and play with it a little bit. If you are using DigitalOcean in the control panel select Networking->Firewalls->Create Firewall. Once created you can <em>assign</em> the firewall to the droplet in the firewall page. As usual DigitalOcean shines on good documentation. You could set some rules and see how they affect your droplet. Generally speaking you should accept the ssh, https and icmp inbound rules and allow all outbound communication.</p><p>If you are of FreeBSD this section will the only one that is a bit different for you. Luckily for you FreeBSD has not one but <a href=https://docs.freebsd.org/en/books/handbook/firewalls/>three firewalls</a>!</p><ol start=2>
<li>Point your domain name to your remote computer</li></ol><p>We want your ip to point to your remote computer, this will buy us two things:</p><ul>
<li>We will be able to do <code>ssh jsmith@example.com</code> instead of using the ip</li><li>Your friends will be able to visit <code>www.example.com</code> and land to your webpage!</li></ul><p>We do this by configuring the DNS records in your DNS host provider. This is not difficult, but I bet you will have some stories to tell if you spend enough time configuring those.
Normally your domain registrar will provide you with a full featured GUI to config those DNS records in the <em>zone file</em>.</p><p>The only thing you have to do is to add a couple of <em>A Record</em>&rsquo;s in your advanced DNS settings. If you are using Namecheap will look something like:
<img src=/images/shoestring/namecheap_a_records.png alt="namecheap config" title="Configuring DNS records"></p><p>Note that we are adding four <code>A record</code>s:</p><ul>
<li><em><code>@</code> Record</em> directs the root domain (&rsquo;example.com&rsquo;) to your IP</li><li><em><code>app</code> Record</em> directs the &lsquo;app.example.com&rsquo; to your IP</li><li><em><code>www</code> Record</em> directs the subdomain &lsquo;<a href=https://www.example.com>www.example.com</a>&rsquo; to your IP</li><li><em><code>p</code> Record</em> directs the &lsquo;p.example.com&rsquo; to your IP</li></ul><p>We will do that to have our webpage sitting in <a href=https://www.example.com>https://www.example.com</a> and our web application sitting in <a href=https://app.example.com>https://app.example.com</a>.</p><p>You don&rsquo;t need to do this. You can have everything in the root domain <a href=https://example.com>https://example.com</a> like <a href=https://twitter.com>https://twitter.com</a> or <a href=https://stackoverflow.com>https://stackoverflow.com</a>. Having a different subdomain for the application can help with a number of issues:</p><ul>
<li>You can have other services in other subdomains independent of the application</li><li>The webpage subdomain and the application subdomain do not share any cookies</li></ul><p>On the other hand if you don&rsquo;t have other services or you have other domains for them and you don&rsquo;t need a flashy landing page you can go and use the root domain.</p><p>At the end of the day wether you want to have the application sitting in your root domain or a subdomain is your decision.</p><p>I added an entrance for <code>p.example.com</code>. Here <code>p</code> stands for <code>private</code> but we can use any other name. In our case we will serve the django admin page from that subdomain.</p><p>You don&rsquo;t need to point all the <code>A Records</code> to the same computer. For example your webpage could be host in a different place like <a href=https://pages.github.com/>GitHub</a>. See the documentation bellow about the Caddyfile.</p><ol start=3>
<li>Set up a simple TLS secured webserver.</li></ol><p>We will now install a webserver in your VPS capable of serving static webpages and redirecting traffic. Apache and NGINX are fine options but will be using <a href=https://caddyserver.com>caddy</a>.</p><p>First thing you should do is download the latest binary for your computer architecture. You can follow the instructions <a href=https://caddyserver.com/docs/install>in the caddy documentation</a> but we will install the latest binary here:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>root@remote# wget https://github.com/caddyserver/caddy/releases/download/v2.7.5/caddy_2.7.5_linux_amd64.tar.gz
</span></span><span class=line><span class=cl>root@remote# tar -xf caddy_2.7.5_linux_amd64.tar.gz
</span></span><span class=line><span class=cl>root@remote# cp caddy /opt/caddy/
</span></span><span class=line><span class=cl>root@remote# chmod +x /opt/caddy/caddy
</span></span></code></pre></div><p>Remember that if you do this you will ned to maintain caddy version&rsquo;s yourself and be specially aware of security updates.</p><p>We will follow <a href=https://caddyserver.com/docs/running>caddy</a>.</p><p>Add an underprivileged user:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>root@remote# groupadd --system caddy
</span></span><span class=line><span class=cl>root@remote# useradd --system --gid caddy --create-home --home-dir /var/lib/caddy --shell /usr/sbin/nologin --comment &#34;Caddy web server&#34; caddy 
</span></span></code></pre></div><p>Create two directories:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>root@remote# mkdir /var/www/api/
</span></span><span class=line><span class=cl>root@remote# mkdir /var/www/website/
</span></span></code></pre></div><p>Now get an <code>index.html</code> file in each of them:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=cp>&lt;!DOCTYPE html&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>html</span> <span class=na>lang</span><span class=o>=</span><span class=s>&#34;en&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>meta</span> <span class=na>charset</span><span class=o>=</span><span class=s>&#34;UTF-8&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>meta</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;viewport&#34;</span> <span class=na>content</span><span class=o>=</span><span class=s>&#34;width=device-width, initial-scale=1.0&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>title</span><span class=p>&gt;</span>Website/App<span class=p>&lt;/</span><span class=nt>title</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>The app is sitting in the website/app endpoint
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span></code></pre></div><p>Make sure that everything is owned and readable by caddy:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>root@remote# chmown -R caddy:caddy /var/www/
</span></span></code></pre></div><p>Create a Caddyfile:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>example.com {
</span></span><span class=line><span class=cl>    redir https://www.example.com{uri}
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>www.example.com {
</span></span><span class=line><span class=cl>	root * /var/www/website/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	file_server
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>app.example.com {
</span></span><span class=line><span class=cl>	root * /var/www/app/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	file_server
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>This is redirecting all traffic from &rsquo;example.com&rsquo; to &lsquo;<a href=https://www.example.com>www.example.com</a>&rsquo;. Anything coming from &lsquo;<a href=https://www.example.com>www.example.com</a>&rsquo; is being served from the directory <code>/var/www/website/</code> and &lsquo;app.example.com&rsquo; is being served from <code>/var/www/app/</code>. As simple as that. In this case both subdomains are served from the same VPS, but that doesn&rsquo;t need to be the case. <a href=https://www.example.com>https://www.example.com</a> could be served form a different machine, maybe done in wordpress or in modern days in webflow or anything else. You could use a static site generator like <a href=https://gohugo.io/>Hugo</a> or <a href=https://www.getzola.org/>Zola</a> or build it yourself if you are brave and host it in GitHub or <a href=https://neocities.org/>Neocities</a>. If you are doing that remember to update the DNS record in your name registrar.</p><p>Finally run caddy:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>root@remote# /opt/caddy/caddy run
</span></span></code></pre></div><p>If you did everything alright and I didn&rsquo;t forget any instructions, by visiting <a href=https://example.com>https://example.com</a> you should be redirected to <a href=https://www.example.com>https://www.example.com</a>. If you visit <a href=https://www.example.com>https://www.example.com</a> or <a href=https://api.example.com>https://api.example.com</a> you should see your two different html files.</p><p>Big congratulations! Note: everything should be <strong>out of the box https</strong> and not http. This is one of the big advantages of using Caddy. You can, of course, use other webservers like NGINX and configurations will not be much more difficult.</p><p>This is all good and dandy. But we can&rsquo;t keep running caddy from the terminal like we are doing now, we need to run it as a service.</p><p>To do that create a <code>/etc/systemd/system/caddy.service</code> with the following content:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[Unit]
</span></span><span class=line><span class=cl>Description=Caddy
</span></span><span class=line><span class=cl>Documentation=https://caddyserver.com/docs/
</span></span><span class=line><span class=cl>After=network.target network-online.target
</span></span><span class=line><span class=cl>Requires=network-online.target
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[Service]
</span></span><span class=line><span class=cl>Type=notify
</span></span><span class=line><span class=cl>User=caddy
</span></span><span class=line><span class=cl>Group=caddy
</span></span><span class=line><span class=cl>ExecStart=/opt/caddy/caddy run --environ --config /etc/caddy/Caddyfile
</span></span><span class=line><span class=cl>ExecReload=/opt/caddy/caddy reload --config /etc/caddy/Caddyfile --force
</span></span><span class=line><span class=cl>TimeoutStopSec=5s
</span></span><span class=line><span class=cl>LimitNOFILE=1048576
</span></span><span class=line><span class=cl>LimitNPROC=512
</span></span><span class=line><span class=cl>PrivateTmp=true
</span></span><span class=line><span class=cl>ProtectSystem=full
</span></span><span class=line><span class=cl>AmbientCapabilities=CAP_NET_ADMIN CAP_NET_BIND_SERVICE
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[Install]
</span></span><span class=line><span class=cl>WantedBy=multi-user.target
</span></span></code></pre></div><p>Copy the Caddyfile to <code>/etc/caddy/Caddyfile</code>.</p><p>Then run to reload the system daemons and the caddy daemon</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>root@remote# systemctl daemon-reload
</span></span><span class=line><span class=cl>root@remote# systemctl start caddy.service
</span></span></code></pre></div><p>The controversial systemd is used across all Linux operating systems and is very powerful but somewhat complex. In you are on FreeBSD you can use the <a href=https://docs.freebsd.org/en/articles/rc-scripting/>BSD-style init</a></p><p>Now you are running Caddy as a service and can shut down your laptop and go for pizza or beer because you had your first deployment. Your system is up and running!</p><p>One final note. In this post we are only interested in the &lsquo;app.example.com&rsquo; part. But for us it will be a bit more complicated because we will not be just serving plain static html files. We will need Caddy to work as a proxy server. We will fix that issue in the coming sections.</p><ol start=4>
<li>Setup the Postgres database</li></ol><p>In your production machine install Postgres and dependencies:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># apt install libpq-dev postgresql postgresql-contrib
</span></span><span class=line><span class=cl># apt install build-essential python3-dev
</span></span></code></pre></div><p>Log into an interactive Postgres session by typing:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># su postgres
</span></span><span class=line><span class=cl>$ psql
</span></span></code></pre></div><p>Create a database in the Postgres prompt. Words in angle brackets ("&lt;>" symbols) are placeholders that you should replace with actual values. For example, &ldquo;&lt;database-user>&rdquo; could become &ldquo;jsmith&rdquo;:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>postgres=# CREATE DATABASE &lt;database-name&gt;;
</span></span><span class=line><span class=cl>postgres=# CREATE USER &lt;database-user&gt; WITH PASSWORD &#39;&lt;database-password&gt;&#39;;
</span></span><span class=line><span class=cl>postgres=# ALTER ROLE &lt;database-user&gt; SET client_encoding TO &#39;utf8&#39;;
</span></span><span class=line><span class=cl>postgres=# ALTER ROLE &lt;database-user&gt; SET default_transaction_isolation TO &#39;read committed&#39;;
</span></span><span class=line><span class=cl>postgres=# ALTER ROLE &lt;database-user&gt; SET timezone TO &#39;UTC&#39;;
</span></span><span class=line><span class=cl>postgres=# GRANT ALL PRIVILEGES ON DATABASE &lt;database-name&gt; TO &lt;database-user&gt;;
</span></span><span class=line><span class=cl>postgres=# GRANT ALL ON SCHEMA public TO &lt;database.user&gt;;
</span></span></code></pre></div><p>Here we just follow the recommendations in the <a href=https://docs.djangoproject.com/en/4.2/ref/databases/#postgresql-notes>Django documentation</a>. The last command is needed in PostgreSQL 15.</p><p>You can, of course use a different database like MariaDB, MySQL, Oracle, CockroachDB, Firebird, Microsoft SQL Server or even MongoDB. We will be using SQLite in local development. Please have a good reason if you don&rsquo;t want to use PostgreSQL.</p><ol start=5>
<li>Create an underprivileged django user:</li></ol><p>This is the user that will run the</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>root@remote# groupadd --system django
</span></span><span class=line><span class=cl>root@remote# useradd --system --gid django --create-home --home-dir /var/lib/django --shell /usr/sbin/nologin --comment &#34;Django app runner&#34; django
</span></span></code></pre></div><p>If your remote branch is private you will need some <em>deployment keys</em> for the user <em>django</em>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>root@remote# su - django -s /bin/bash -c &#39;ssh-keygen -t ed25519 -C &#34;Deployment key&#34; -N &#34;&#34; -f ~/.ssh/id_ed25519&#39;
</span></span></code></pre></div><p>You should add that key to your <a href=https://docs.github.com/en/authentication/connecting-to-github-with-ssh/managing-deploy-keys#deploy-keys>GitHub remote repository</a>. Make sure it does not have writing permissions.</p><h2 id=local-development-and-architecture>Local development and architecture</h2><p>Now that we&rsquo;ve successfully set up the remote machine and it&rsquo;s all set for our application, let&rsquo;s focus on how we&rsquo;ll be developing the application locally.</p><p>What I&rsquo;m about to share isn&rsquo;t exactly the standard approach, but it&rsquo;s a method I personally prefer for local development. In a modern web application, you typically have two key components: the backend and the frontend. Normally, both of these components have their own development servers. These development servers aren&rsquo;t meant for production use, but they offer some useful features like Hot Module Reloading (HMR). So, during development, most folks end up running two local servers on their machines, each listening on different ports (one for the frontend and one for the backend).</p><p>There are various ways to manage this, but I find a straightforward solution is to use Caddy as a proxy server. It&rsquo;s worth noting that Caddy is a lightweight tool – just a single binary. You won&rsquo;t need to install any hefty dependencies or deal with strange configurations on your laptop. To kickstart your workday, all you need to do is open a terminal and run the following commands.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>jsmith@local:~/Project/example$ caddy run
</span></span></code></pre></div><p>The Caddyfile could be something like:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>:2080
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># django API
</span></span><span class=line><span class=cl>reverse_proxy /api/* localhost:8000
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># admin API
</span></span><span class=line><span class=cl>reverse_proxy /admin/* localhost:8000
</span></span><span class=line><span class=cl>reverse_proxy /static/admin/* localhost:8000
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># everything else is the frontend 
</span></span><span class=line><span class=cl>reverse_proxy :5173
</span></span></code></pre></div><p>That means the frontend is running on port 5173 and the Django backend will be running on port 8000 but our whole application will be running on port 2080. Now in a different terminal head over to the frontend folder and run:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>jsmith@local:~/Project/example/frontend_test$ python -m http.server 5173
</span></span></code></pre></div><p>Today, this will serve as our frontend server. In a future installment of this series, we&rsquo;ll replace it with a more sophisticated, React-aware, HMR-enabled, and cache-friendly development frontend server.</p><p>For now, these two terminals won&rsquo;t cause much interference in our workflow.</p><p>You might be wondering why we have those two entries in the Caddyfile related to the Django API. We&rsquo;ll dive into their purpose later, and we&rsquo;ll also explore how to handle them in a production environment.</p><p>In production, we&rsquo;ll have a setup quite similar to this, where we&rsquo;ll differentiate between requests for static files and API requests. Here&rsquo;s how it works: a remote machine, say a browser, will send requests to our server located at <a href=https://app.example.com>https://app.example.com</a>, for example. These requests fall into two categories:</p><ol>
<li>Static content: This includes JavaScript files, HTML, CSS, images – essentially public resources.</li><li>API calls: These requests require server-side processing.</li></ol><p>Some websites are solely of the first type – they simply serve the content you request. Personal blogs and websites mostly fall into this category. You can even host them for free on platforms like GitHub or <a href=https://neocities.org/>Neocities</a> among others. They don&rsquo;t involve login, database queries, or e-commerce functionality. These are known as static websites and are relatively straightforward to create.</p><p>The second type of requests necessitates a server or program to process data and return relevant information. For instance, a search engine needs to provide a list of URLs containing specific information. Many of these API calls are public and open for anyone to use, while some might be private, accessible only to users who have logged into the system.</p><h2 id=the-app-design-and-wireframes>The app design and wireframes</h2><p>Although today&rsquo;s aim is not the frontend we will build a frontend to have a fully functioning application. When designing an app or a website about the first things you need to do is the <em>wireframes</em>. Those are the low fidelity designs of what the application will do. Wireframes are not necessarily done by designers, they will probably came afterwards creating pixel perfect designs of your ideas.</p><p>There are many wireframing tools out there, but I will not mention any of them as I will leave that for our frontend discussions. For our purposes I will create the diagrams we need with <a href=https://www.drawio.com/>https://www.drawio.com/</a>.</p><p>Our web application will be as simple as possible. Users can:</p><ul>
<li>Log in and see, update and delete their personal data</li><li>Log out</li><li>Create accounts</li><li>Recover password via email</li></ul><p>Just the bare minimum that a world changing app needs to have. The frontend will be all done in HTML, modern JavaScript and CSS. No frills.</p><p>This are the wireframes:
<img src=/images/shoestring/ExampleApp.svg alt="example app wireframes" title="Wireframe for a simple App"></p><p>When the user goes to our website <a href=https://app.example.com>https://app.example.com</a>, three things can happen:</p><ul>
<li>If they are not logged in, you will see screen (1)</li><li>If they are logged in as a normal user they will be greeted in screen (2)</li><li>If they are admins they will see the list of users in the platform (2B)</li></ul><p>I think the rest are pretty self explanatory. Notice that at this point we do not specify every single detail:</p><ul>
<li>What happens if you if you type a incorrect password?</li><li>The real implementation might be quite different after a designer sees some of the wireframes and decides to change the UX here and there</li><li>The exact wording will change</li><li>&mldr;</li></ul><p>Now you can go over the <a href=https://github.com/nhatcher/users-template/tree/main/frontend_test>frontend_test</a> folder and see the code there. We will not discuss it here.</p><h2 id=the-database-design>The database design</h2><p>We finally get to the backend code and design. The first thing we need to think about is the database structure.</p><p>We obviously need a table with users that has to store username, an encrypted password, name, last name, email, etc.</p><p>The users table might also include pictures, a telephone number and what not.
Things start getting more complicated when you realize you need to store session data. How do we know a user is already logged in? Also sites should be protected from <em>cross-ste request forgery</em> or CSRF. And probably a couple of other issues we haven&rsquo;t thought just yet. That&rsquo;s when <em>django</em> jumps in. Now, we are not going to design the authentication part of the database ourselves, we could, and we will probably do that on another occasion, but if we are using django, that is done for us. Of course Django&rsquo;s database schema might not be exactly what we want and we will need to adapt it for our own purposes.</p><p>We will extend Django&rsquo;s &lsquo;auth_users&rsquo; with our own &lsquo;user_profile&rsquo; table that will have a one to one link with Django users. This way we can add some extra information to every user without having to change the internal system. Also the framework doesn&rsquo;t have a way to create accounts or recover passwords. We will need to design that.</p><p>When someone creates an account it will be disabled until they click on the link that was send by email.
The way we will do this is to have a new table (model in the parlance of Django) called &lsquo;pending_users&rsquo; that has a one to one link to a &lsquo;user&rsquo; that is initially disabled. It will also contain the &rsquo;email_token&rsquo;.</p><p>Another table &lsquo;recover_password&rsquo; will contain the emails and email tokens send to those users that asked to recover their password.</p><p>And that&rsquo;s pretty much it for this project. In production we will be using a PostgreSQL database and we will use Sqlite3 in development.</p><h2 id=setting-up-the-django-project>Setting up the django project</h2><p>To begin with let&rsquo;s create a new folder for our application:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>jsmith@local:~/Projects/$ mkdir example-app
</span></span><span class=line><span class=cl>jsmith@local:~/Projects/$ cd example-app
</span></span></code></pre></div><p>Now create a virtual environment for the project:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>jsmith@local:~/Projects/example-app$ python -m venv venv
</span></span></code></pre></div><p>Where the second venv could be any name you like</p><p>Activate the virtual environment:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>jsmith@local:~/Projects/example-app$ source venv/bin/activate
</span></span></code></pre></div><p>Install django:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>(venv) $ pip install django
</span></span></code></pre></div><p>You will need to think a bit about the directory structure you want. In our case we want two directories in the root directory of out project ‘frontend’ or client and ‘server’. We will go ahead and create those two directories and move to the sever directory:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>(venv) $ mkdir server
</span></span><span class=line><span class=cl>(venv) $ cd server
</span></span></code></pre></div><p>Now we create a django project in that directory:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>(venv) $ django-admin startproject settings .
</span></span></code></pre></div><p>Note two things. We call the project ‘settings’. That is because we want to have a settings directory for the django admin. Also note the period and the end. This is to create the project in our current directory. We call it settings so that django places all config stuff in there.</p><p>There is a bit of configuration we still need to do. First we are going to use different setting for production and local development:</p><ul>
<li>We don&rsquo;t want to send real emails</li><li>We don&rsquo;t want to send logs to our log backend. We will probably be happy seeing the emails and the logs in our terminal.</li><li>We don&rsquo;t want a PostgreSQL database while development. SQlite3 will do just fine.</li><li>We want HMR while development and full stack traces</li><li>We don&rsquo;t need access to secret keys</li></ul><p>See the <a href=https://github.com/nhatcher/users-template/tree/main/server/settings/settings>source code</a> to understand the specifics.</p><h2 id=the-users-or-accounts-app>The users or accounts app</h2><p>A Django project revolves around the concept of apps. A Django application is a self-contained unit that encapsulates specific functionality within a Django project. Django apps are designed to be reusable and can be plugged into different projects, which makes them a fundamental building block of Django web development.</p><p>Almost every project is going to need an accounts or users app. The bulk of the code we will write today is in this app. This is our first stop:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>(venv) $ python manage.py startapp users
</span></span></code></pre></div><p>In this app we need to define:</p><ol>
<li><em>Models</em>: Models define the structure and behavior of the database tables for your app. Each model corresponds to a table in the database and includes fields (representing table columns) and methods for interacting with the data. In our example, &ldquo;user_profile,&rdquo; &ldquo;pending_users,&rdquo; and &ldquo;recover_password&rdquo; are all appropriate names for models. Models are a critical part of your app, as they determine how data is stored and manipulated.</li><li><em>URLs (URL Routing)</em>: The URLs module in your app defines the URL patterns or routes for your app&rsquo;s endpoints. These patterns map specific URLs to views within your app.</li><li><em>Views</em>: Views are responsible for handling HTTP requests and returning HTTP responses. They contain the logic for processing data, rendering templates, or returning data in formats like JSON. Views determine what happens when a specific endpoint is accessed. It&rsquo;s essential to provide details about how views interact with the URL routing and how they respond to different HTTP methods (e.g., GET, POST).</li><li><em>Tests</em>: everything within the app should be thoroughly tested. This is a crucial aspect of Django development</li><li><em>Admin</em>: The admin module is where you can define custom configurations for your app&rsquo;s models within the Django admin interface. You can specify how your models should be displayed and edited by administrators. This is particularly useful for managing app-specific data through the admin panel.</li></ol><p>Once all the code is in place we are ready to test the app locally! Just need to create the migrations and run them:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>(venv) $ python manage.py makemigrations
</span></span><span class=line><span class=cl>(venv) $ python manage.py migrate
</span></span></code></pre></div><p>Once that is done if your caddy proxy server is running and your python frontend server is running you just need to:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>(venv) $ python manage.py runserver
</span></span></code></pre></div><p>And head over to <a href=https://localhost:2080/>https://localhost:2080/</a> to see your application. You should also see the Django admin page at <a href=https://localhost:2080/admin/>https://localhost:2080/admin/</a></p><p>Note the database file <code>db.sqlite3</code> will be sitting along side <code>manage.py</code> and you can check it. You can open that file with the <code>sqlite3</code> cli, use a sqlite browser like <a href=https://sqlitestudio.pl/>SqliteStudio</a> or simply use a VS Code <a href="https://marketplace.visualstudio.com/items?itemName=qwtel.sqlite-viewer">Sqlite Viewer</a>. In either case to be able to log in the Django admin panel you will need to be a superuser. Using the CLI:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ sqlite3 db.sqlite3 
</span></span><span class=line><span class=cl>SQLite version 3.37.2 2022-01-06 13:25:41
</span></span><span class=line><span class=cl>Enter &#34;.help&#34; for usage hints.
</span></span><span class=line><span class=cl>sqlite&gt; UPDATE auth_user SET is_superuser=TRUE WHERE username=&#34;jsmith&#34;;
</span></span></code></pre></div><p>Or you can create a superuser with:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>(venv) $ python manage.py createsuperuser
</span></span></code></pre></div><p>As stated above tests are a crucial component of a Django application and, in fact, are vital for any computer program. They are essential for ensuring that the software works correctly and reliably, regardless of the specific technology or framework being used. Ti run the tests here:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>(venv) $ python manage.py test
</span></span></code></pre></div><p>Remember that the <code>manage.py</code> uses the development settings by default.</p><p>Typically there might be as many lines of code for tests as there are for production code. And you will need to think them thoroughly. Focus on testing the logic first, not on lines of code covered. It&rsquo;s very easy, although sometimes cumbersome, to test every line of the code but to miss important logical branches of the code. It is very easy to skip tests on a first proof of concept, thinking you might rewrite this properly in the future. In my experience that is not normally how things go down. You start writing a bit of code for a proof of concept and that code ends ups growing out of hand with a bad foundation. A good part of the reason for this blog post and code is to help you get started in a project with a solid foundation.</p><p>You should spend some time understanding how the tests work. In many situations you are going to find yourself thinking a piece of code is difficult to test. That might be so, refactor, make the thing testable. At times you will need to mock a part of the application, we don&rsquo;t want to send real emails in tests or we don&rsquo;t really have a browser. You will need to think how to do that in a clean way. Specially at the beginning of the development you shouldn&rsquo;t focus on test coverage, trying to cover every line of code and it is ok to leave some parts out rather than install complicated frameworks that will help you testing weird corner cases. Sometimes tests that way end up being a heavy luggage. As long as the testing framework is in place and you have an easy system to add new tests and you are covering the main logical branches of your code you are ready to take off.</p><p>Enough about tests for now, we will meet them again in a later section dedicated just for them.</p><h2 id=the-type-checker-the-formatter-and-the-linter>The type checker, the formatter and the linter</h2><p>Python is showing it&rsquo;s age and doesn&rsquo;t have many of the features that are now taken for granted in more modern languages. In particular it doesn&rsquo;t have types, meaning it&rsquo;s very easy to call a function with incorrect types, for example. Because of this there is a growth in tools that intend to patch the issues in different ways. Picking a particular set of tools and configuring them correctly might be overwhelming.</p><p>What I describe here is just one selection, as long as you are checking types, adhering to a style guide and having a code formatter.</p><p>We will use <a href=https://microsoft.github.io/pyright/#/>pyright</a> by Microsoft for the type checker. There are many other options, <a href=https://www.mypy-lang.org/>mypy</a> is the reference type checker but mymy seems to be having many issues with Django.</p><p>We will use <a href=https://github.com/psf/black>black</a> for our code formatter and <a href=https://flake8.pycqa.org/en/latest/>flake8</a> to enforce a style guide. We will also use <a href=https://pycqa.github.io/isort/>isort</a> to order our imports consistently.</p><p>You will need to run this tools every time you commit code to the repository and make sure that code is conformant.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>(venv) $ pip install pyright
</span></span><span class=line><span class=cl>(venv) $ pip install black
</span></span><span class=line><span class=cl>(venv) $ pip install flake8
</span></span><span class=line><span class=cl>(evnv) $ pip install isort
</span></span></code></pre></div><p>I leave the configuration options and settings for you, but you can find ours in <a href=https://github.com/nhatcher/users-template/blob/main/.flake8>.flake8</a> and <a href=https://github.com/nhatcher/users-template/blob/main/pyproject.toml>pyproject.toml</a>. Note that you need to run isort in the black compatibility mode.</p><h2 id=tests-test-runner-test-coverage-and-github-actions>Tests, test runner, test coverage and GitHub actions</h2><p>We will use <a href=https://docs.pytest.org/>pytest</a> and <a href=https://pypi.org/project/pytest-cov/>pytest-cov</a>. To install this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>(venv) $ pip install pytest
</span></span><span class=line><span class=cl>(venv) $ pip install pytest-django
</span></span><span class=line><span class=cl>(venv) $ pip install pytest-cov
</span></span></code></pre></div><p>This is a nicer way to run the tests than running <code>python manage.py test</code> for a number of reasons, richer test discovery, more concise syntax, you can do parametrized testing, parallel test execution, custom test makers and use plugins like the coverage tool we will be using.</p><p>Running:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>(venv) $ pytest --cov-report term-missing --cov server
</span></span></code></pre></div><p>Will run all your tests, run a test coverage and tell you which lines are not yet covered.</p><p>This is the important bit, all test need to pass before merging more work into the main branch. This includes not only the Django tests but also the type checker, formatter and linters. I have put all of them in the <a href=https://github.com/nhatcher/users-template/blob/main/run_tests.sh>run_test.sh</a> executable.</p><p>Test should run automatically with every push, either to remote branches or to main. We can do that with <a href=https://docs.github.com/en/actions/quickstart>GitHub actions</a>. You just need to do a <code>.github/workflows/django.yml</code> file in your repo with content:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Django CI</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>on</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>push</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>branches</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=w> </span><span class=s2>&#34;main&#34;</span><span class=w> </span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pull_request</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>branches</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=w> </span><span class=s2>&#34;main&#34;</span><span class=w> </span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>jobs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>build</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>runs-on</span><span class=p>:</span><span class=w> </span><span class=l>ubuntu-latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>strategy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>max-parallel</span><span class=p>:</span><span class=w> </span><span class=m>4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>matrix</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>python-version</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=m>3.10.13</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>steps</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class=l>actions/checkout@v3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Set up Python ${{ matrix.python-version }}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class=l>actions/setup-python@v3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>with</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>python-version</span><span class=p>:</span><span class=w> </span><span class=l>${{ matrix.python-version }}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Install Dependencies</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>        python -m pip install --upgrade pip
</span></span></span><span class=line><span class=cl><span class=sd>        pip install -r requirements.txt</span><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Run Tests</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>./run_tests.sh</span><span class=w>
</span></span></span></code></pre></div><p>Now every time you do a PR the test should run and in the PR GitHub page you should see wether the tests passed or not. With a free GitHub account you can&rsquo;t prevent (lock) the feature branch to be merged if the test do not pass. But you should not live with a main branch with failing tests. If you go to the repository <a href=https://github.com/nhatcher/users-template/actions>Actions</a> you should see the list of all the times the test run. You can click on any of them and see the issues and the test coverage.</p><h2 id=logs-alerts-notifications-and-stats>Logs, alerts, notifications and stats</h2><p>Logs are messages emitted by the application or the operative system that can help us trace back errors or issues that happened through an event or series of events.
It can be informative, signal a warning or be worrisome errors.</p><p>Alerts are messages that we receive in our phones. We probably need to act on them. They signal a house on fire event.</p><p>Notifications are also messages that we receive in our movil devices that are just for our information, for example new accounts created.</p><p>Some logs may be upgraded to alerts or notifications depending on their importance.</p><p>Stats are numbers of certain occurrences that we feel are important. Like number of accounts created or the number of times people logged in into the system.</p><p>You really need logs in place.</p><p>To inspect caddy logs:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>root@remote:~# tail /etc/log/caddy/access.log 
</span></span></code></pre></div><p>A nice way to inspect those logs is <a href=https://jqlang.github.io/jq/>jq</a>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tail -f /var/log/caddy/access.log  <span class=p>|</span> jq .request.uri
</span></span></code></pre></div><h2 id=deploying-to-production>Deploying to production</h2><p>Deployment should be extremely simple:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>root@remote:~# deploy.sh
</span></span></code></pre></div><p>This should:</p><ol>
<li>Stop the Gunicorn daemon</li><li>Get all the code from the remote repository as the underprivileged django user</li><li>Create the virtual environment and install all the production dependencies</li><li>Apply the migrations to the database.</li><li>Collect the static files that Django needs and copy them to the static folder</li><li>Copy all files that need to be copied</li></ol><p>But deployment is a dangerous operation and involves downtime. At the beginning of the development of your application you might not have users and this might not be an issue. But as soon as you are having customers you should plan deployments. Also since you are migrating the database in place you should do a backup and test it works before the deployment. You can spin a new droplet, copy the database, make sure it works and then do the deployment in your production machine.</p><p>One way of doing this would be to get a new subdomain for the new droplet. For example <code>test</code> or <code>staging</code>, you could get a new random name using the utility <code>util/generate_subdomain.py</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>jsmith@local:~/util$ python generate_subdomain.py
</span></span><span class=line><span class=cl>tools-steals
</span></span></code></pre></div><p>Then add this name to your DNS A records. Once you have done that, prepare your new machine by <code>./install.sh</code> and deploy the same code that is deployed at your production VPS.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>root@tools-steals:~/ deploy.sh commit-id
</span></span></code></pre></div><p>Make a <a href=https://www.postgresql.org/docs/current/backup-dump.html>dump of the database</a> in the &lsquo;production&rsquo; machine:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>root@remote:~# su - postgres -c <span class=s1>&#39;pg_dump &lt;database-name&gt; &gt; database_backup.sql&#39;</span>
</span></span><span class=line><span class=cl>root@remote:~# cp ~postgres/database_backup.sql .
</span></span></code></pre></div><p>Copy that file to the new &lsquo;staging&rsquo; machine:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>jsmith@local:~/$ scp root@example.com:~/database_backup root@tools-steals.example.com:~/
</span></span></code></pre></div><p>Restore the dump in the new machine:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>root@tools-steals:~# su - postgres -c <span class=s2>&#34;psql -c &#39;DROP DATABASE &lt;database-name&gt;&#39;&#34;</span>
</span></span><span class=line><span class=cl>root@tools-steals:~# su - postgres -c <span class=s2>&#34;psql -c &#39;CREATE DATABASE eqn_app&#39;&#34;</span>
</span></span><span class=line><span class=cl>root@tools-steals:~# su - postgres -c <span class=s1>&#39;psql eqn_app &lt; database_backup.sql&#39;</span>
</span></span></code></pre></div><p>Now do the deployment in the new machine:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>root@tools-steals:~# deploy.sh
</span></span></code></pre></div><p>Check that everything is ok. This involves manual testing, logging into the new machine, checking the users are there and test if it makes sense that the migrations worked out the way you wanted.</p><p>Once you are happy with the result you are free to go to the production machine and do the deployment there:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>root@remote:~# deploy.sh
</span></span></code></pre></div><p>You can now do a smoke test of the production machine and eventually destroy the staging &rsquo;tools-steals&rsquo; machine.
It will cost you just a few cents if the whole process lasted for an hour or two.</p><h2 id=database-backups>Database backups</h2><p>At the beginning and while you are developing your application backups might not be up in your list. But as soon as you start having users the most important thing you have is your users data. DigitalOcean does weekly backups of your whole droplet for peanuts.
The one important thing about the backups is that you need to test they work. Don&rsquo;t just assume they work. Remember once again the most valuable thing you have right now is your customer data. If you don&rsquo;t want to spend cash you can setup a cron job (see later) to make a dump of your database to AWS S3 (free for a year) or any other place. As you grow, you probably will want a managed database anyway. That is a separate machine that you will have to pay for but the provider will take care of things like daily backups. When and how you start doing backups is completely up to you. But you will need to have tested database backups in place.</p><h2 id=troubleshooting>Troubleshooting</h2><p>I you can ping the server ssh into the server the OS is up and running.</p><p>Can I check deployed version? <a href=https://app.example.com/deployed_commit_id.txt>https://app.example.com/deployed_commit_id.txt</a> then Caddy is up and running.
You can check the gunicorn logs:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>root@remote:~# journalctl -u gunicorn -f
</span></span></code></pre></div><p>Then you can check the application logs:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>root@remote:~# tail -f /var/log/django/django.log
</span></span></code></pre></div><h2 id=extra-a-a-virtual-personal-network>Extra A: A Virtual Personal Network</h2><p>These days is extremely easy to get all your computers, including your phone and your laptop on the same private network. Today the best tool out there is <a href=https://tailscale.com/>tailscale</a>. It&rsquo;s free and foolproof.
I wil not go in this blog post into installing or the benefits of a VPN but I will just mention one.</p><p>Because we have the django admin site in a subdomain <a href=https://p.example.com>https://p.example.com</a> we could make it only accessible from the VPN. The right way of doing that is with something called a DNS challenge. Regrettably the set of tools that we are using (Namecheap+Caddy) make this a tad more complicated than with others (GoDaddy+NGINX). A simple enough way of doing it would be:</p><ol>
<li>Expose <a href=https://p.exampe.com>https://p.exampe.com</a> and let Caddy get the certificate as usual</li><li>Change the A record in your DNS provider of <a href=https://p.example.com>https://p.example.com</a> to point to the private IP in the VPN.</li></ol><p>That&rsquo;s it for three months your certificate is valid and <a href=https://p.example.com>https://p.example.com</a> is only accessible from the VPN.</p><h2 id=extra-b-infrastructure-defined-by-code>Extra B: Infrastructure defined by code</h2><p>So far every time we need a new server there are a few manual steps we need to take. Changing some DNS A records, creating a new droplet with the correct ssh keys, rsync the deployment scripts, fill out the server_config file, etc. Although this works it eventually will get error prone. The infrastructure will start growing, maybe new machines added, load balancers, separate managed databases, &mldr;</p><p>The solution is to do for the infrastructure the same as we did for the rest of the system define it by code. Most host providers like DigitalOcean feature an API that allow users provision machines and services via code. Name registrars like Namecheap also provide an API to control them programmatically. And you can also control your DNS records from DigitalOcean and leave your Name registrar out of the equation. This basically means we can do a full installation of the whole system just running one script.</p><p>We can even go one step further. Our installation and deployment scripts are <em>imperative</em> they say whats needs to be done in order to get to the sate that we want. Modern infrastructure is defined <em>declaratively</em>. Instead of having a series of scripts we have now a <em>yaml</em> file that describes what we want to have. This is the basis for <a href=https://www.terraform.io/>terraform</a></p><p>Dawn E. Collett has given an excellent <a href="https://www.youtube.com/watch?v=zrORVZ9wJSE&amp;ab_channel=TechWorldwithNana">talk</a> about how to use terraform for a small <a href=https://github.com/lisushka/osc-terraform>open source</a> project on a shoestring.</p><h2 id=even-more-extras>Even more extras!</h2><p>There are infinity many nice things you could be adding to the project to make your life (and your collaborators&rsquo;) easier.</p><ol>
<li>
<p>Cron jobs</p><p>A good example is database cleaning. You might want to run a job every day/week/hour to remove entries in the database that are no longer relevant. For example entries for users whose link has expired.</p></li><li>
<p>unattended updates. Caddy updates</p><p>If you machine is running long enough it will need updates. At least you need the security updates. Updates like <code>apt update && apt upgrade</code> are potentially dangerous because they might install updates that break existing software. So you probably want to do those during a normal deployment. DigitalOcean, as usual, has a good <a href=https://www.digitalocean.com/community/tutorials/how-to-keep-ubuntu-22-04-servers-updated>blog post</a> on how to do that. We did install Caddy from a link, so it is not managed, it will not be automatically upgraded even if there are security patches. But since it is a single binary you can just download the latest version. At the time of writing there is an experimental feature <code>caddy upgrade</code> that works pretty well.</p></li><li>
<p>Vaults and secrets. Terraform vault.</p><p>A critical part of all this setting is the mysterious file <code>server_config.ini</code> with all the secrets and passwords. If you copy that file to the wrong place you will expose all your secrets. This happens more often than it should. The modern way of dealing with this is using a third party like <a href=https://www.vaultproject.io/>HashiCorp Vault Project</a>. It&rsquo;s free.</p></li><li>
<p>Mock data</p><p>When testing the app it is very useful to have the app filled mock data. For that we have a script that fills the database and returns a file with users and passwords.
We will probably talk about this when we talk about the frontend.</p></li><li>
<p>Deployments on tagging (push deployments)</p><p>I like ssh-ing into our server and running <code>deploy.sh</code>. It&rsquo;s simple and you can see the logs on your terminal. And it&rsquo;s probably the best solution if it is just you. If you have a couple of collaborators then is probably a good idea to have a better way of doing deployments. One idea is to use deployments every time there is a push to the main branch. There are many ways of achieving that.</p></li><li>
<p>You name it!</p></li></ol><h2 id=where-to-go-next-and-departing-words>Where to go next and departing words</h2><p>Well, really. Once everything is in place it&rsquo;s time to set the frontend and start codding! If you went through all the steps your are basically done with the scaffolding&rsquo;s boilerplate.</p><p>In a following blog post, hopefully way shorter than this, I will show you how to get started with React+TypeScript+Storybook and how all three can be easily integrated in the present infrastructure.</p></div><div class=post-footer>
<div class=info>
</div></div><div id=fb_comments_container>
<h2>comments</h2><script src=https://utteranc.es/client.js repo=nhatcher/nhatcher.github.io issue-term=pathname theme=preferred-color-scheme crossorigin=anonymous async></script>
</div></div></div></div></div><script type=text/javascript src=https://www.nhatcher.com/js/jquery.min.e80d7e6008943348b2c88cd12f10e546083ff6a88f06b4afac7151b78886417e.js integrity="sha256-6A1+YAiUM0iyyIzRLxDlRgg/9qiPBrSvrHFRt4iGQX4=" crossorigin=anonymous></script>
<script type=text/javascript src=https://www.nhatcher.com/js/bundle.min.3ebad6bf39b2e7c2f899d3ed9bc97e8c0c1ead7a1b57472e3387321f673b8077.js integrity="sha256-PrrWvzmy58L4mdPtm8l+jAwerXobV0cuM4cyH2c7gHc=" crossorigin=anonymous></script>
<script type=text/javascript src=https://www.nhatcher.com/js/medium-zoom.min.e1c6918cbaa90022a5612f0bd71c7bf3be6d036614c5729cebfe14f7b91fa4bc.js integrity="sha256-4caRjLqpACKlYS8L1xx7875tA2YUxXKc6/4U97kfpLw=" crossorigin=anonymous></script>
</body></html>