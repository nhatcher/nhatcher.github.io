<!doctype html><html lang=en data-theme><head>
<title> Nicolás Hatcher | A CTO playbook on a shoestring </title><meta charset=utf-8><meta name=generator content="Hugo 0.119.0"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name=description content="Software developer by trade, physicist by soul">
<link rel=stylesheet href=https://www.nhatcher.com/css/style.min.0c643de4008adca329f7a2d616ce308cca99d4ef45e4cca307323e7857910194.css integrity="sha256-DGQ95ACK3KMp96LWFs4wjMqZ1O9F5MyjBzI+eFeRAZQ=" crossorigin=anonymous type=text/css>
<link rel=stylesheet href=https://www.nhatcher.com/css/markupHighlight.min.f798cbda9aaa38f89eb38be6414bd082cfd71a6780375cbf67b6d2fb2b96491e.css integrity="sha256-95jL2pqqOPies4vmQUvQgs/XGmeAN1y/Z7bS+yuWSR4=" crossorigin=anonymous type=text/css>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA==" crossorigin=anonymous>
<link rel="shortcut icon" href=https://www.nhatcher.com/favicons/favicon.ico type=image/x-icon>
<link rel=apple-touch-icon sizes=180x180 href=https://www.nhatcher.com/favicons/apple-touch-icon.png>
<link rel=icon type=image/png sizes=32x32 href=https://www.nhatcher.com/favicons/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=https://www.nhatcher.com/favicons/favicon-16x16.png>
<link rel=canonical href=https://www.nhatcher.com/post/a-cto-on-a-shoestring/>
<script type=text/javascript src=https://www.nhatcher.com/js/anatole-header.min.df804b63b5bd8474ea0756ea874bc8f1e92552708cc6ea43aa0d76981dc419f9.js integrity="sha256-34BLY7W9hHTqB1bqh0vI8eklUnCMxupDqg12mB3EGfk=" crossorigin=anonymous></script>
<script type=text/javascript src=https://www.nhatcher.com/js/anatole-theme-switcher.min.3829579c725749492568b0e6fa9da3012a7fc37fd291b4fd79e33c1df5d8a34a.js integrity="sha256-OClXnHJXSUklaLDm+p2jASp/w3/SkbT9eeM8HfXYo0o=" crossorigin=anonymous></script>
<meta name=twitter:card content="summary">
<meta name=twitter:title content="A CTO playbook on a shoestring">
<meta name=twitter:description content="All the code in this blog post is in github and you should have a look at that first and come here only for further assistance.">
</head><body><div class="sidebar .">
<div class=logo-title>
<div class=title>
<img src=https://www.nhatcher.com/images/profile.jpg alt="profile picture">
<h3 title><a href=/>I'm Nicolás Hatcher</a></h3><div class=description>
<p>Software developer by trade, physicist by soul</p></div></div></div><ul class=social-links>
<li>
<a href="https://arxiv.org/search/?searchtype=author&amp;query=Hatcher%2C+N" rel=me aria-label=Publications>
<i class="fas fa-file-alt fa-2x" aria-hidden=true></i>
</a>
</li><li>
<a href=https://github.com/nhatcher/ rel=me aria-label=GitHub>
<i class="fab fa-github fa-2x" aria-hidden=true></i>
</a>
</li><li>
<a href=https://www.instagram.com/theuniverse.today rel=me aria-label=instagram>
<i class="fab fa-instagram fa-2x" aria-hidden=true></i>
</a>
</li><li>
<a href=mailto:nicolas@theuniverse.today rel=me aria-label=e-mail>
<i class="fas fa-envelope fa-2x" aria-hidden=true></i>
</a>
</li></ul><div class=footer>
<div class=by_farbox>&copy; Nicolás Hatcher 2023 </div></div></div><div class=main>
<div class="page-top .">
<a role=button class=navbar-burger data-target=navMenu aria-label=menu aria-expanded=false>
<span aria-hidden=true></span>
<span aria-hidden=true></span>
<span aria-hidden=true></span>
</a>
<ul class=nav id=navMenu>
<li><a href=/ title>Home</a></li><li><a href=/post/ title>Posts</a></li><li><a href=/about/ title>About</a></li><li class=theme-switch-item>
<a class=theme-switch title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i>
</a>
</li></ul></div><div class=autopagerize_page_element>
<div class=content>
<div class="post .">
<div class=post-content>
<div class=post-title>
<h3>A CTO playbook on a shoestring</h3><div class=info>
<em class="fas fa-calendar-day"></em>
<span class=date> Sun, Oct 15, 2023
</span>
<em class="fas fa-stopwatch"></em>
<span class=reading-time>30-minute read</span>
</div></div><p>All the code in this blog post is in <a href=https://github.com/nhatcher/users-template>github</a> and you should have a look at that first and come here only for further assistance.</p><p>This post was <strong>last updated on Sun, Oct 15, 2023</strong></p><p>In this blog post you are going to learn how to setup and deploy a simple web application with modern best programming practices and all the bells and whistles you need to grow the app from zero to a few hundred users.
There might be some things you want to do differently from code in here. You might want to use a different platform to read your logs, you might want to use nginx instead of caddy, you might want to run your django code with Daphne instead of gunicorn, you might decide GitHub is not good for you, or use a different email provider or host provider or get the domain name from a different name registrar. All good you will still be able to use this with minimal modifications. Changing Django and python for a different framework or programming language will require more changes but the core of this post will still be useful. Using <a href=https://laravel.com/>Lavarel</a>, <a href=https://rubyonrails.org/>Ruby on Rails</a> or plain <a href=https://go.dev/>go</a> should pose no big challenges to the reader.</p><p>This should not only be regarded as a tutorial on how to setup and install everything but as a guide on how to build a modern web application.</p><p>The guide is intended for a small team, maybe just one single person. If your team is larger than 5 people this guide might still work but might fall short in some respects. I am assuming you have almost no cash to dedicate to this project, we are going to do this on a shoestring. With all this in place if you make the project grow from a solo developer and no users to a few hundred users and 5 developer you will very easily upgrade the tools and hardware. I am assuming also you have some background in programming and you are comfortable in a Linux terminal. If you are not you really need a more technical partner that will help you with that. You will also not learn Django or python here although you should be ok if you know just some python and are willing to dedicate some time go go through the Django documentation.</p><p>Although I am guiding you through the cheapest possible option, as soon as you start getting customers you should consider investing in infrastructure. Maybe you will need a separate database server o a more performant server or paying for some of the services you are using.</p><p>This is not the only way to setup a server. There are tons of other ways of doing this. Some might want to use <a href=https://www.heroku.com/>Heroku</a> or <a href=https://fly.io/>Fly.io</a> or a completely managed <a href=https://www.cloudron.io/>Cloudron</a>. There are of course the big enterprise solutions like <a href=https://cloud.google.com/>Google Cloud</a>, <a href=https://aws.amazon.com/>AWS</a> or <a href=https://azure.microsoft.com/>Microsoft Azure</a></p><p>Lastly we will not be setting the frontend here. All we are going to do here is completely frontend agnostic. You could do the whole frontend in vanilla HTML, CSS and JavaScript or use any modern framework like React and TypeScript.</p><p>After having setup toy webapps following similar patterns as we will be following here the idea of this project came when I join forces with Lu Bertolucci to work on his project &lsquo;feirou&rsquo;. As I had some available time in my hand I thought this was a good moment to do this right.</p><p>Many of the things that I will recommend here I learn from my coworkers during the past 14 years! I also have them to thank.</p><p>A brief note on nomenclature. I will assume that your username is &lsquo;jsmith&rsquo;, that your local&rsquo;s name computer is &rsquo;local&rsquo;, your remote name computer is &lsquo;remote&rsquo;, the name of the domain you bought is &rsquo;example.com&rsquo; and that the ip in your VPS is &lsquo;93.184.216.34&rsquo;.
If you are following in Linux or Mac you will have no issues. If you are following in a windows machine and are working in the WSL it should be pretty straightforward. Otherwise you might need to tweak some commands for your own environment and OS. When you see a command like:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>root@remote# apt install failban
</span></span></code></pre></div><p>means that you are running this command as root in the remote machine. And the remote folder is not important. Note that you know that it is a root user because the prompt ends with &lsquo;#&rsquo; and not with &lsquo;$&rsquo;. With this provisions I hope it is clear where are you running what command.</p><p>Finally, I will check links and versions. I will try not to link to third party blogs but prefer tools documentation. That said, links might be broken. I will always try to provide information about the link so you can search the internet easily.</p><h2 id=getting-a-domain-name-10-a-year>Getting a domain name (~10€ a year)</h2><p>You can buy a domain name from places like <a href=https://www.namecheap.com/>namecheap</a>, but there are many other vendors. Just make sure that they only sell you the domain name and nothing else. It should cost you around 10€ a year. But you can find really cheap domain names for a year you can get for your testing. Beware of not renewing them, those cost go up and add!</p><h2 id=getting-an-email-account>Getting an email account</h2><p>There are several paid vendors like Google. But we will use <a href=https://www.zoho.com/mail/zohomail-pricing.html>Zoho</a> that for now is free. Scroll down to the &ldquo;forever free plan&rdquo;. You can use one provider now and move to a different one in the future. Because you own the domain name you will not need to change email addresses. The only problem you might have to deal with is exporting from Zoho and importing them again in the new platform if you ever want to do that.</p><p>Zoho has a nice web service and apps for Android and iOS to read and send your email from the phone.</p><p>To setup your email, you will need to follow the steps in one of these guides, <a href=https://www.namecheap.com/support/knowledgebase/article.aspx/9758/2208/how-to-set-up-zoho-email-for-my-domain/>namecheap</a> or <a href=https://www.zoho.com/mail/help/adminconsole/namecheap.html>zoho</a>.</p><p>With this done you should be able to send a receive emails with your new fancy email address. You can up to 5 email accounts, for instance <code>hello@example.com</code> and <code>support@example.com</code> but you can configure zoho to get all emails on <code>hello@example.com</code>. You can also now send emails programmatically.</p><p>Now you should be able to send an email programmatically:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>smtplib</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>email.mime.text</span> <span class=kn>import</span> <span class=n>MIMEText</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>email.header</span> <span class=kn>import</span> <span class=n>Header</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>email.utils</span> <span class=kn>import</span> <span class=n>formataddr</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Configure in zoho</span>
</span></span><span class=line><span class=cl><span class=n>password</span> <span class=o>=</span> <span class=s2>&#34;my secret password&#34;</span>
</span></span><span class=line><span class=cl><span class=n>domain</span> <span class=o>=</span> <span class=s2>&#34;example.com&#34;</span>
</span></span><span class=line><span class=cl><span class=n>sender_user</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;support@</span><span class=si>{</span><span class=n>domain</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>send_email</span><span class=p>(</span><span class=n>email</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># Define to/from</span>
</span></span><span class=line><span class=cl>    <span class=n>subject</span> <span class=o>=</span> <span class=s2>&#34;First email ever!&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>sender_title</span> <span class=o>=</span> <span class=s2>&#34;Example App Support&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Create message</span>
</span></span><span class=line><span class=cl>    <span class=n>msg</span> <span class=o>=</span> <span class=n>MIMEText</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;Hello world!&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;plain&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;utf-8&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>msg</span><span class=p>[</span><span class=s2>&#34;Subject&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=n>Header</span><span class=p>(</span><span class=n>subject</span><span class=p>,</span> <span class=s2>&#34;utf-8&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>msg</span><span class=p>[</span><span class=s2>&#34;From&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=n>formataddr</span><span class=p>((</span><span class=nb>str</span><span class=p>(</span><span class=n>Header</span><span class=p>(</span><span class=n>sender_title</span><span class=p>,</span> <span class=s2>&#34;utf-8&#34;</span><span class=p>)),</span> <span class=n>sender_user</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>msg</span><span class=p>[</span><span class=s2>&#34;To&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=n>email</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Create server object with SSL option</span>
</span></span><span class=line><span class=cl>    <span class=n>server</span> <span class=o>=</span> <span class=n>smtplib</span><span class=o>.</span><span class=n>SMTP_SSL</span><span class=p>(</span><span class=s2>&#34;smtp.zoho.com&#34;</span><span class=p>,</span> <span class=mi>465</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Perform operations via server</span>
</span></span><span class=line><span class=cl>    <span class=n>server</span><span class=o>.</span><span class=n>login</span><span class=p>(</span><span class=n>user</span><span class=p>,</span> <span class=n>password</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>server</span><span class=o>.</span><span class=n>sendmail</span><span class=p>(</span><span class=n>user</span><span class=p>,</span> <span class=p>[</span><span class=n>email</span><span class=p>],</span> <span class=n>msg</span><span class=o>.</span><span class=n>as_string</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>server</span><span class=o>.</span><span class=n>quit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># who do you want to send the email to:</span>
</span></span><span class=line><span class=cl>    <span class=n>to_address</span> <span class=o>=</span> <span class=s2>&#34;jsmith@example.com&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>send_email</span><span class=p>(</span><span class=n>to_address</span><span class=p>)</span>
</span></span></code></pre></div><h2 id=server-provision-and-setup-5-a-month>Server provision and setup (~5€ a month)</h2><p>This is by far the most complicated bit. But you only have to do it once.</p><p>Before even getting a VPS you need a pair of ssh keys. You probably have already done it for GitHub.</p><p>Your cloud provider will probably let you <a href=https://docs.digitalocean.com/products/droplets/how-to/add-ssh-keys/to-team/>upload your public key</a> so that every new VPS will have the ssh key installed.</p><p>I am using an instance in <a href=https://www.digitalocean.com/>DigitalOcean</a> basic droplets that at the time of writing are advertised as 4$/month but because of billing issues turns out to be around 4.5€ a month. This is enough for our purposes.
Other options are <a href=https://www.scaleway.com/en/>Scaleway</a>, <a href=https://www.linode.com/>Linode</a>, <a href=https://www.hetzner.com/>Hetzner</a>, and many others. Most notably <a href=https://www.oracle.com/cloud/free/>Oracle Cloud</a> offers a forever free tier!</p><ol>
<li>Secure the server</li></ol><p>Log into the remote server. That is normally done by:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>jsmith@local:~/ $ ssh root@93.184.216.34
</span></span></code></pre></div><p>Where <code>93.184.216.34</code> is just the example IP.</p><p>Install <code>fail2ban</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>root@remote# apt install fail2ban
</span></span></code></pre></div><p>Make sure you can only ssh with a key and not with a password. So <code>ssh root@93.184.216.34</code> only works form your computer with the private ssh key.</p><p>Note that playing with firewall is a little dangerous, not only you can expose your machine to the rest of the internet if you do something wrong, you can also you lock yourself out if you set the wrong rules. Some vendors give you a direct console access to your VPS and that will mitigate the issue. But if you don&rsquo;t have direct console access tread carefully. So read all the documentation first and apply the rules that are convenient only after understanding what you are doing.</p><p>A firewall is a piece if software, or hardware, that acts as security barrier monitoring and controlling incoming and outgoing network traffic based on a set of predefined rules or policies. The Linux kernel has a build in <a href=https://en.wikipedia.org/wiki/Netfilter>Netfilter</a> framework that we can control in userspace with a command-line utility, &lsquo;iptables&rsquo;, that allows you to configure and manage firewall rules and network packet filtering. In layperson terms this means that at the Operative System level we have a way to check all data coming in or going out of your computer.</p><p>Raw &lsquo;iptables&rsquo; commands are hard to understand, even for experts and there are other programs designed to generate this rules for you. A good example is the &lsquo;fail2ban&rsquo; command above. In ubuntu system the program &lsquo;UFW&rsquo;, (the Uncomplicated FireWall) is widely used. The following will deny all incoming traffic and allow all outgoing, then allow all ssh, http and https. Hopefully it is self explanatory.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>root@remote# apt install ufw
</span></span><span class=line><span class=cl>root@remote# ufw disable
</span></span><span class=line><span class=cl>root@remote# ufw default deny incoming
</span></span><span class=line><span class=cl>root@remote# ufw default allow outgoing
</span></span><span class=line><span class=cl>root@remote# ufw allow ssh
</span></span><span class=line><span class=cl>root@remote# ufw allow http
</span></span><span class=line><span class=cl>root@remote# ufw allow https
</span></span><span class=line><span class=cl>root@remote# ufw enable
</span></span></code></pre></div><p>And it that worked 100% of the cases I wouldn&rsquo;t have had to tell you about &lsquo;iptables&rsquo; in the first place. If you are administrating a VPS chances are you will have to see the face of the tiger sooner rather than later.</p><p>If you can&rsquo;t use UFW a set of rules that works well for our purposes is:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1># Flush existing rules</span>
</span></span><span class=line><span class=cl>iptables -F
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Allow incoming SSH (port 22) traffic</span>
</span></span><span class=line><span class=cl>iptables -A INPUT -p tcp --dport <span class=m>22</span> -j ACCEPT
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Allow established connections</span>
</span></span><span class=line><span class=cl>iptables -A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Allow incoming HTTP (port 80) traffic</span>
</span></span><span class=line><span class=cl>iptables -A INPUT -p tcp --dport <span class=m>80</span> -j ACCEPT
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Allow incoming HTTPS (port 443) traffic</span>
</span></span><span class=line><span class=cl>iptables -A INPUT -p tcp --dport <span class=m>443</span> -j ACCEPT
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Allow loopback (localhost) traffic</span>
</span></span><span class=line><span class=cl>iptables -A INPUT -i lo -j ACCEPT
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Allow ICMP (ping) traffic</span>
</span></span><span class=line><span class=cl>iptables -A INPUT -p icmp --icmp-type echo-request -j ACCEPT
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Set the default policies to DROP (block all other incoming traffic)</span>
</span></span><span class=line><span class=cl>iptables -P INPUT DROP
</span></span><span class=line><span class=cl>iptables -P FORWARD DROP
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Allow all outgoing traffic</span>
</span></span><span class=line><span class=cl>iptables -P OUTPUT ACCEPT
</span></span></code></pre></div><p>You can run the commands one by one or run in in a file <code>firewall-setting.sh</code>.
If you want to make a backup of your current rules before you do your foolishness:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># iptables-save &gt; ~/iptables-rules
</span></span></code></pre></div><p>And to restore them:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># iptables-restore iptables-rules
</span></span></code></pre></div><p>You need to know that applying iptables rules are not persisted after boot. So if you do get locked out just reboot your VPS. There are several ways to persist the rules. Creating a system script like we have done for caddy and gunicorn is not a bad way:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[Unit] 
</span></span><span class=line><span class=cl>Description=runs iptables restore on boot
</span></span><span class=line><span class=cl>ConditionFileIsExecutable=/opt/util/restore-iptables.sh
</span></span><span class=line><span class=cl>After=network.target
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[Service]
</span></span><span class=line><span class=cl>Type=forking
</span></span><span class=line><span class=cl>ExecStart=/opt/util/restore-iptables.sh
</span></span><span class=line><span class=cl>start TimeoutSec=0
</span></span><span class=line><span class=cl>RemainAfterExit=yes
</span></span><span class=line><span class=cl>GuessMainPID=no
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[Install]
</span></span><span class=line><span class=cl>WantedBy=multi-user.target
</span></span></code></pre></div><p>And then the <code>restore-iptables.sh</code> script would be:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/sh
</span></span></span><span class=line><span class=cl><span class=cp></span>/usr/bin/flock /run/.iptables-restore /opt/util/iptables-restore /etc/iptables/rules.v4
</span></span></code></pre></div><p>Create a user and add it to the sudoers list. Make sure you can ssh with that user and remove ssh root access to the machine.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>root@remote# adduser username
</span></span></code></pre></div><p>Where username is your username, for instance &lsquo;jsmith&rsquo;. Add it to the sudoers list:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>root@remote# usermod -aG sudo jsmith
</span></span></code></pre></div><p>As <code>jsmith</code> copy the contents of the root&rsquo;s <code>authorized_keys</code> file (usually at <code>/root/.ssh/authorized_keys</code>) to the username&rsquo;s <code>authorized_keys</code> file (<code>/home/username/.ssh/authorized_keys</code>). In a different terminal test that you can ssh as the new username:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>jsmith@local:~/ $ ssh jsmith@93.184.216.34
</span></span></code></pre></div><p>Once in the remote computer check that you can become a superuser by typing <code>sudo su</code> and entering your password. Now keep your password safe and delete the contents of the root&rsquo;s <code>authorized_keys</code> file. The contents not the file.</p><p>Congratulations, you have secured your server. You should not be able to ssh as root anymore.</p><p>Now, there are still services running on your computer you might not be aware of. One of them is the OSI layer 3 echo ICMP server built in the operative system. For your laptop at home try:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>jsmith@local:~/ $ ping -c 5 example.com
</span></span><span class=line><span class=cl>PING example.com (93.184.216.34) 56(84) bytes of data.
</span></span><span class=line><span class=cl>64 bytes from example.com (93.184.216.34): icmp_seq=1 ttl=52 time=26.0 ms
</span></span><span class=line><span class=cl>64 bytes from example.com (93.184.216.34): icmp_seq=2 ttl=52 time=30.1 ms
</span></span><span class=line><span class=cl>64 bytes from example.com (93.184.216.34): icmp_seq=3 ttl=52 time=24.4 ms
</span></span><span class=line><span class=cl>64 bytes from example.com (93.184.216.34): icmp_seq=4 ttl=52 time=25.7 ms
</span></span><span class=line><span class=cl>64 bytes from example.com (93.184.216.34): icmp_seq=5 ttl=52 time=27.8 ms
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>--- example.com ping statistics ---
</span></span><span class=line><span class=cl>5 packets transmitted, 5 received, 0% packet loss, time 4006ms
</span></span><span class=line><span class=cl>rtt min/avg/max/mdev = 24.359/26.784/30.122/1.988 ms
</span></span></code></pre></div><p>This is helpful to test if your computer is up and the network is listening. Note that we have not allowed the service in the firewall, yet it is there running. This is telling you that a round trip time for ping request to your machine is around 26 milliseconds.</p><p>Your cloud provider might also feature some firewall settings. I don&rsquo;t think that setting a firewall both at the os level and at the cloud provider level would break anything but it&rsquo;s probably not a great idea since it might lead to difficult to debug issues. But you should go ahead and read about the firewall in your cloud provider and play with it a little bit. If you are using DigitalOcean in the control panel select Networking->Firewalls->Create Firewall. Once created you can <em>assign</em> the firewall to the droplet in the firewall page. As usual DigitalOcean shines on good documentation. You could set some rules and see how they affect your droplet. Generally speaking though you should accept the ssh, https and icmp inbound rules and allow all outbound communication.</p><ol start=2>
<li>Point your domain name to your remote computer</li></ol><p>We want your ip to point to your remote computer, this will buy us two things:</p><ul>
<li>We will be able to do <code>ssh jsmith@example.com</code> instead of using the ip</li><li>Your friends will be able to visit <code>www.example.com</code> and land to your webpage!</li></ul><p>We do this by configuring the DNS records in your DNS host provider. This is not difficult, but I bet you will have some stories to tell if you spend enough time configuring those.
Normally your domain registrar will provide you with a full featured GUI to config those DNS records in the <em>zone file</em>.</p><p>The only thing you have to do is to add a couple of <code>A Record</code>&rsquo;s in your advanced DNS settings. If you are using Namecheap will look something like:
<img src=/images/shoestring/namecheap_config.png alt="namecheap config" title="Configuring DNS records"></p><p>Note that we are adding three <code>A record</code>s:</p><ul>
<li><em><code>@</code> Record</em> directs the root domain (&rsquo;example.com&rsquo;) to your IP</li><li><em><code>www</code> Record</em> directs the subdomain &lsquo;<a href=https://www.example.com>www.example.com</a>&rsquo; to your IP</li><li><em><code>app</code> Record</em> directs the &lsquo;app.example.com&rsquo; to your IP</li></ul><p>We will do that to have our webpage sitting in <a href=https://www.example.com>https://www.example.com</a> and our web application sitting in <a href=https://app.example.com>https://app.example.com</a>.</p><p>You don&rsquo;t need to do this. You can have everything in the root domain <a href=https://example.com>https://example.com</a> like <a href=https://twitter.com>https://twitter.com</a> or <a href=https://stackoverflow.com>https://stackoverflow.com</a>. Having a different subdomain for the application can help with a number of issues:</p><ul>
<li>You can have other services in other subdomains independent of the application</li><li>The webpage subdomain and the application subdomain do not share any cookies</li></ul><p>On the other hand if you don&rsquo;t have other services or you have other domains for them and you don&rsquo;t need a flashy landing page you can go and use the root domain.</p><p>At the end of the day wether you want to have the application sitting in your root domain or a subdomain is your decision.</p><ol start=3>
<li>Set up a simple TLS secured webserver.</li></ol><p>We will now install a webserver in your VPS capable of serving static webpages and redirecting traffic. Apache and nginx are fine options but will be using <a href=https://caddyserver.com>caddy</a>.</p><p>First thing you should do is download the latest binary for your computer architecture. You can follow the instructions <a href=https://caddyserver.com/docs/install>in the caddy documentation</a> but we will install the latest binary here:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>root@remote# wget https://github.com/caddyserver/caddy/releases/download/v2.7.4/caddy_2.7.4_linux_amd64.tar.gz
</span></span><span class=line><span class=cl>root@remote# tar -xf caddy_2.7.4_linux_amd64.tar.gz
</span></span><span class=line><span class=cl>root@remote# cp caddy /opt/caddy/
</span></span><span class=line><span class=cl>root@remote# chmod +x /opt/caddy/caddy
</span></span></code></pre></div><p>Remember that if you do this you will ned to maintain caddy version&rsquo;s yourself and be specially aware of security updates.</p><p>We will follow <a href=https://caddyserver.com/docs/running>caddy</a>.</p><p>Add an underprivileged user</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>root@remote# groupadd --system caddy
</span></span><span class=line><span class=cl>root@remote# useradd --system --gid caddy --create-home --home-dir /var/lib/caddy --shell /usr/sbin/nologin --comment &#34;Caddy web server&#34; caddy 
</span></span></code></pre></div><p>Create two directories:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>root@remote# mkdir /var/www/api/
</span></span><span class=line><span class=cl>root@remote# mkdir /var/www/website/
</span></span></code></pre></div><p>Now get an <code>index.html</code> file in each of them:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=cp>&lt;!DOCTYPE html&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>html</span> <span class=na>lang</span><span class=o>=</span><span class=s>&#34;en&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>meta</span> <span class=na>charset</span><span class=o>=</span><span class=s>&#34;UTF-8&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>meta</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;viewport&#34;</span> <span class=na>content</span><span class=o>=</span><span class=s>&#34;width=device-width, initial-scale=1.0&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>title</span><span class=p>&gt;</span>Website/App<span class=p>&lt;/</span><span class=nt>title</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>The app is sitting in the website/app endpoint
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span></code></pre></div><p>Make sure that everything is readable by caddy:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>root@remote# chmown -R caddy:caddy /var/www/
</span></span></code></pre></div><p>Create a Caddyfile:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>example.com {
</span></span><span class=line><span class=cl>    redir https://www.example.com{uri}
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>www.example.com {
</span></span><span class=line><span class=cl>	root * /var/www/website/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	file_server
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>app.example.com {
</span></span><span class=line><span class=cl>	root * /var/www/app/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	file_server
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>This is redirecting all traffic from &rsquo;example.com&rsquo; to &lsquo;<a href=https://www.example.com>www.example.com</a>&rsquo;. Anything coming from &lsquo;<a href=https://www.example.com>www.example.com</a>&rsquo; is being served from the directory <code>/var/www/website/</code> and &lsquo;app.example.com&rsquo; is being served from <code>/var/www/app/</code>. As simple as that. In this case both subdomains are served from the same VPS, but that doesn&rsquo;t need to be the case. <a href=https://www.example.com>https://www.example.com</a> could be served form a different machine, maybe done in wordpress or in modern days in webflow or anything else. You could use a static site generator like <a href=https://gohugo.io/>Hugo</a> or <a href=https://www.getzola.org/>Zola</a> or build it yourself if you are brave and host it in GitHub or <a href=https://neocities.org/>Neocities</a></p><p>Finally run caddy:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>root@remote# /opt/caddy/caddy run
</span></span></code></pre></div><p>If you did everything alright and I didn&rsquo;t forget any instruction by visiting <a href=https://example.com>https://example.com</a> you should be redirected to <a href=https://www.example.com>https://www.example.com</a>. If you visit <a href=https://www.example.com>https://www.example.com</a> or <a href=https://api.example.com>https://api.example.com</a> you should see your two different html files.</p><p>Big congratulations! Note: everything should be out of the box https and not http. This is one of the big advantages of using caddy. You can, of course, use other webservers like nginx and configurations will not be much more difficult.</p><p>This is all good and dandy. But we can&rsquo;t keep running caddy from the terminal like we are doing now, we need to run it as a service.</p><p>To do that create a <code>/etc/systemd/system/caddy.service</code> with the following content:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[Unit]
</span></span><span class=line><span class=cl>Description=Caddy
</span></span><span class=line><span class=cl>Documentation=https://caddyserver.com/docs/
</span></span><span class=line><span class=cl>After=network.target network-online.target
</span></span><span class=line><span class=cl>Requires=network-online.target
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[Service]
</span></span><span class=line><span class=cl>Type=notify
</span></span><span class=line><span class=cl>User=caddy
</span></span><span class=line><span class=cl>Group=caddy
</span></span><span class=line><span class=cl>ExecStart=/opt/caddy/caddy run --environ --config /etc/caddy/Caddyfile
</span></span><span class=line><span class=cl>ExecReload=/opt/caddy/caddy reload --config /etc/caddy/Caddyfile --force
</span></span><span class=line><span class=cl>TimeoutStopSec=5s
</span></span><span class=line><span class=cl>LimitNOFILE=1048576
</span></span><span class=line><span class=cl>LimitNPROC=512
</span></span><span class=line><span class=cl>PrivateTmp=true
</span></span><span class=line><span class=cl>ProtectSystem=full
</span></span><span class=line><span class=cl>AmbientCapabilities=CAP_NET_ADMIN CAP_NET_BIND_SERVICE
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[Install]
</span></span><span class=line><span class=cl>WantedBy=multi-user.target
</span></span></code></pre></div><p>Copy the Caddyfile to <code>/etc/caddy/Caddyfile</code>.</p><p>Then run to reload the system daemons and the caddy daemon</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>root@remote# systemctl daemon-reload
</span></span><span class=line><span class=cl>root@remote# systemctl start caddy.service
</span></span></code></pre></div><p>Now you are running caddy as a service and can shut down your laptop and go for pizza or beer because you had your first deployment. Your system is up and running!</p><p>One final note. In this post we are only interested in the &lsquo;app.example.com&rsquo; part. But for us it will be a bit more complicated because we will not be just serving plain static html files. We will need Caddy to work as a proxy server. We will fix that issue in the coming sections.</p><ol start=4>
<li>Setup the Postgres database</li></ol><p>In your production machine install Postgres and dependencies:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># apt install libpq-dev postgresql postgresql-contrib
</span></span><span class=line><span class=cl># apt install build-essential python3-dev
</span></span></code></pre></div><p>Log into an interactive Postgres session by typing:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># su postgres
</span></span><span class=line><span class=cl>$ psql
</span></span></code></pre></div><p>Create a database in the Postgres prompt. Words in angle brackets ("&lt;>" symbols) are placeholders that you should replace with actual values. For example, &ldquo;&lt;database-user>&rdquo; could become &ldquo;jsmith&rdquo;:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>postgres=# CREATE DATABASE &lt;database-name&gt;;
</span></span><span class=line><span class=cl>postgres=# CREATE USER &lt;database-user&gt; WITH PASSWORD &#39;&lt;database-password&gt;&#39;;
</span></span><span class=line><span class=cl>postgres=# ALTER ROLE &lt;database-user&gt; SET client_encoding TO &#39;utf8&#39;;
</span></span><span class=line><span class=cl>postgres=# ALTER ROLE &lt;database-user&gt; SET default_transaction_isolation TO &#39;read committed&#39;;
</span></span><span class=line><span class=cl>postgres=# ALTER ROLE &lt;database-user&gt; SET timezone TO &#39;UTC&#39;;
</span></span><span class=line><span class=cl>postgres=# GRANT ALL PRIVILEGES ON DATABASE &lt;database-name&gt; TO &lt;database-user&gt;;
</span></span></code></pre></div><p>Here we just follow the recommendations in the <a href=https://docs.djangoproject.com/en/4.2/ref/databases/#postgresql-notes>Django documentation</a></p><p>You can, of course use a different database like MariaDB, MySQL, Oracle, CockroachDB, Firebird, Microsoft SQL Server or even MongoDB. We will be using SQLite in local development. Please have a good reason if you don&rsquo;t want to use PostgreSQL.</p><ol start=5>
<li>Create an underprivileged django user:
This is the user that will run the</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>root@remote# groupadd --system django
</span></span><span class=line><span class=cl>root@remote# useradd --system --gid django --create-home --home-dir /var/lib/django --shell /usr/sbin/nologin --comment &#34;Django app runner&#34; django
</span></span></code></pre></div><h2 id=local-development-and-architecture>Local development and architecture</h2><p>Now that we have setup the remote machine and is ready for our application let&rsquo;s turn our eyes how we are going to develop the application locally.</p><p>This bit I am going to show you now is not really standard but it is how I like doing local development. In a modern web application, there are two parts, the backend and the frontend. In general both parts have their own development servers. Those development servers are not production ready and they give you goodies like HMR (Hot Module Reloading). So during development most people will have two local servers running on their machines listening on two different ports (port-frontend and port-backend). People have designed all sorts of ways to work with this but I think a very simple one is to put caddy in front as a proxy server. Remember that caddy is just one small binary, there are no huge dependencies to install o weird things running on your laptop. At the beginning of your working day you can fire up a terminal and run</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>jsmith@local:~/Project/example$ caddy run
</span></span></code></pre></div><p>The Caddyfile could be something like:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>:2080
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># django API
</span></span><span class=line><span class=cl>reverse_proxy /api/* localhost:8000
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># admin API
</span></span><span class=line><span class=cl>reverse_proxy /admin/* localhost:8000
</span></span><span class=line><span class=cl>reverse_proxy /static/admin/* localhost:8000
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># everything else is the frontend 
</span></span><span class=line><span class=cl>reverse_proxy :5173
</span></span></code></pre></div><p>That means the frontend is running on port 5173 and the django backend will be running on port 8000 but our whole application will be running on port 2080. Now in a different terminal head over to the frontend folder abd run:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>jsmith@local:~/Project/example/frontend_test$ python -m http.server 5173
</span></span></code></pre></div><p>For today this will our frontend server. In a later installment of this series we will substitute that with a fancy React aware, HMR featured, cache friendly development frontend server.</p><p>For now those two terminals will be mostly out of our way.</p><p>You might have left wondering what those two entries in the Caddyfile about the django API are doing there. We will get to those later and see how we deal with that in production too.</p><p>We will have a very similar setting in production splitting the requests for static files from the API requests. It works in the following way. A remote machine (a browser) will make requests to our server sitting in <a href=https://app.example.com>https://app.example.com</a> for example. There are two kinds of requests:</p><ol>
<li>Static content like JavaScript files, HTML, CSS, images that are public</li><li>API calls that will need to be processed by the server</li></ol><p>There are many websites, that are only of the first kind. They will just serve you the content you asked for. Personal websites and blogs are mostly of that kind.
You can host them for free on GitHub or <a href=https://neocities.org/>Neocities</a> or many other places. You cannot login in those pages or consult a database or buy stuff. Those are called static websites and they are fairly easy to do.</p><p>The second kind of requests need a server, a program, to process some data and send some other data back. For instance a search engine will need to send a lits of URLs that contain some information. Many of those API calls are public, meaning everybody can use the service. Some might be private and only accessible if a user has logged in into the system.</p><h2 id=the-app-design-and-wireframes>The app design and wireframes</h2><p>Although today&rsquo;s aim is not the frontend we will build a frontend to have a fully functioning application. When designing an app or a website about the first things you need to do is the <em>wireframes</em>. Those are the low fidelity designs of what the application will do. Wireframes are not necessarily done by designers, they will probably came afterwards creating pixel perfect designs of your ideas.</p><p>There are many wireframing tools out there, but I will not mention any of them as I will leave that for our frontend discussions. For our purposes I will create the diagrams we need with <a href=https://www.drawio.com/>https://www.drawio.com/</a>.</p><p>Our web application will be as simple as possible. Users can:</p><ul>
<li>Log in and see, update and delete their personal data</li><li>Log out</li><li>Create accounts</li><li>Recover password via email</li></ul><p>Just the bare minimum that a world changing app needs to have. The frontend will be all done in HTML, modern JavaScript and CSS. No frills.</p><p>This are the wireframes:
<img src=/images/shoestring/ExampleApp.svg alt="example app wireframes" title="Wireframe for a simple App"></p><p>When the user goes to our website <a href=https://app.example.com>https://app.example.com</a>, three things can happen:</p><ul>
<li>If they are not logged in, you will see screen (1)</li><li>If they are logged in as a normal user they will be greeted in screen (2)</li><li>If they are admins they will see the list of users in the platform (2B)</li></ul><p>I think the rest are pretty self explanatory. Notice that at this point we do not specify every single detail:</p><ul>
<li>What happens if you if you type a incorrect password?</li><li>The real implementation might be quite different after a designer sees some of the wireframes and decides to change the UX here and there</li><li>The exact wording will change</li><li>&mldr;</li></ul><p>Now you can go over the <a href=https://github.com/nhatcher/users-template/tree/main/frontend_test>frontend_test</a> folder and see the code there. We will not discuss it here.</p><h2 id=the-database-design>The database design</h2><p>We finally get to the backend code and design. The first thing we need to think about is the database structure.</p><p>We obviously need a table with users that has to store username, an encrypted password, name, last name, email, &mldr;
The users table might also include pictures, a telephone number and what not.
Things start getting more complicated when you realize you need to store session data. How do we know a user is already logged in? Also sites should be protected from <em>cross-ste request forgery</em> or CSRF. And probably a couple of other issues we haven&rsquo;t thought just yet. That&rsquo;s when <em>django</em> jumps in. Now, we are not going to design the authentication part of the database ourselves, we could, and we will probably do that on another occasion, but if we are using django, that is done for us. Of course Django&rsquo;s database schema might not be exactly what we want and we will need to adapt it for our own purposes.</p><p>We will extend Django&rsquo;s &lsquo;auth_users&rsquo; with our own &lsquo;user_profile&rsquo; table that will have a one to one link with Django users. This way we can add some extra information to every user without having to change the internal system. Also the framework doesn&rsquo;t have a way to create accounts or recover passwords. We will need to design that.</p><p>When someone creates an account it will be disabled until they click on the link that was send by email.
The way we will do this is to have a new table (model in the parlance of Django) called &lsquo;pending_users&rsquo; that has a one to one link to a &lsquo;user&rsquo; that is initially disabled. It will also contain the &rsquo;email_token&rsquo;.</p><p>Another table &lsquo;recover_password&rsquo; will contain the emails and email tokens send to those users that asked to recover their password.</p><p>And that&rsquo;s pretty much it for this project. In production we will be using a PostgreSQL database and we will use Sqlite3 in development.</p><h2 id=setting-up-the-django-project>Setting up the django project</h2><p>To begin with let&rsquo;s create a new folder for our application:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>jsmith@local:~/Projects/$ mkdir example-app
</span></span><span class=line><span class=cl>jsmith@local:~/Projects/$ cd example-app
</span></span></code></pre></div><p>Now create a virtual environment for the project:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>jsmith@local:~/Projects/example-app$ python -m venv venv
</span></span></code></pre></div><p>Where the second venv could be any name you like</p><p>Activate the virtual environment:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>jsmith@local:~/Projects/example-app$ source venv/bin/activate
</span></span></code></pre></div><p>Install django:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>(venv) $ pip install django
</span></span></code></pre></div><p>You will need to think a bit about the directory structure you want. In our case we want two directories in the root directory of out project ‘frontend’ or client and ‘server’. We will go ahead and create those two directories and move to the sever directory:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>(venv) $ mkdir server
</span></span><span class=line><span class=cl>(venv) $ cd server
</span></span></code></pre></div><p>Now we create a django project in that directory:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>(venv) $ django-admin startproject settings .
</span></span></code></pre></div><p>Note two things. We call the project ‘settings’. That is because we want to have a settings directory for the django admin. Also note the period and the end. This is to create the project in our current directory. We call it settings so that django places all config stuff in there.</p><p>There is a bit of configuration we still need to do. First we are going to use different setting for production and local development:</p><ul>
<li>We don&rsquo;t want to send real emails</li><li>We don&rsquo;t want to send logs to our log backend. We will probably be happy seeing the emails and the logs in our terminal.</li><li>We don&rsquo;t want a PostgreSQL database while development. SQlite3 will do just fine.</li><li>We want HMR while development and full stack traces</li><li>We don&rsquo;t need access to secret keys</li></ul><p>See the <a href=https://github.com/nhatcher/users-template/tree/main/server/settings/settings>source code</a> to understand the specifics.</p><h2 id=the-users-or-accounts-app>The users or accounts app</h2><p>A Django project revolves around the concept of apps. A Django application is a self-contained unit that encapsulates specific functionality within a Django project. Django apps are designed to be reusable and can be plugged into different projects, which makes them a fundamental building block of Django web development.</p><p>Almost every project is going to need an accounts or users app. The bulk of the code we will write today is in this app. This is our first stop:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>(venv) $ python manage.py startapp users
</span></span></code></pre></div><p>In this app we need to define:</p><ol>
<li><em>Models</em>: Models define the structure and behavior of the database tables for your app. Each model corresponds to a table in the database and includes fields (representing table columns) and methods for interacting with the data. In our example, &ldquo;user_profile,&rdquo; &ldquo;pending_users,&rdquo; and &ldquo;recover_password&rdquo; are all appropriate names for models. Models are a critical part of your app, as they determine how data is stored and manipulated.</li><li><em>URLs (URL Routing)</em>: The URLs module in your app defines the URL patterns or routes for your app&rsquo;s endpoints. These patterns map specific URLs to views within your app.</li><li><em>Views</em>: Views are responsible for handling HTTP requests and returning HTTP responses. They contain the logic for processing data, rendering templates, or returning data in formats like JSON. Views determine what happens when a specific endpoint is accessed. It&rsquo;s essential to provide details about how views interact with the URL routing and how they respond to different HTTP methods (e.g., GET, POST).</li><li><em>Tests</em>: everything within the app should be thoroughly tested. This is a crucial aspect of Django development</li><li><em>Admin</em>: The admin module is where you can define custom configurations for your app&rsquo;s models within the Django admin interface. You can specify how your models should be displayed and edited by administrators. This is particularly useful for managing app-specific data through the admin panel.</li></ol><p>Once all the code is in place we are ready to test the app locally! Just need to create the migrations and run them:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>(venv) $ python manage.py makemigrations
</span></span><span class=line><span class=cl>(venv) $ python manage.py migrate
</span></span></code></pre></div><p>Once that is done if your caddy proxy server is running and your python frontend server is running you just need to:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>(venv) $ python manage.py runserver
</span></span></code></pre></div><p>And head over to <a href=https://localhost:2080/>https://localhost:2080/</a> to see your application. You should also see the Django admin page at <a href=https://localhost:2080/admin/>https://localhost:2080/admin/</a></p><p>Note the database file <code>db.sqlite3</code> will be sitting along side <code>manage.py</code> and you can check it. You can open that file with the <code>sqlite3</code> cli, use a sqlite browser like <a href=https://sqlitestudio.pl/>SqliteStudio</a> or simply use a VS Code <a href="https://marketplace.visualstudio.com/items?itemName=qwtel.sqlite-viewer">Sqlite Viewer</a>. In either case to be able to log in the Django admin panel you will need to be a superuser. Using the CLI:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ sqlite3 db.sqlite3 
</span></span><span class=line><span class=cl>SQLite version 3.37.2 2022-01-06 13:25:41
</span></span><span class=line><span class=cl>Enter &#34;.help&#34; for usage hints.
</span></span><span class=line><span class=cl>sqlite&gt; UPDATE auth_user SET is_superuser=TRUE WHERE username=&#34;jsmith&#34;;
</span></span></code></pre></div><p>Or you can create a superuser with:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>(venv) $ python manage.py createsuperuser
</span></span></code></pre></div><p>As stated above tests are a crucial component of a Django application and, in fact, are vital for any computer program. They are essential for ensuring that the software works correctly and reliably, regardless of the specific technology or framework being used. Ti run the tests here:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>(venv) $ python manage.py test
</span></span></code></pre></div><p>Remember that the <code>manage.py</code> uses the development settings by default.</p><p>Typically there might be as many lines of code for tests as there are for production code. And you will need to think them thoroughly. Focus on testing the logic first, not on lines of code covered. It&rsquo;s very easy, although sometimes cumbersome, to test every line of the code but to miss important logical branches of the code. It is very easy to skip tests on a first proof of concept, thinking you might rewrite this properly in the future. In my experience that is not normally how things go down. You start writing a bit of code for a proof of concept and that code ends ups growing out of hand with a bad foundation. A good part of the reason for this blog post and code is to help you get started in a project with a solid foundation.</p><p>You should spend some time understanding how the tests work. In many situations you are going to find yourself thinking a piece of code is difficult to test. That might be so, refactor, make the thing testable. At times you will need to mock a part of the application, we don&rsquo;t want to send real emails in tests or we don&rsquo;t really have a browser. You will need to think how to do that in a clean way. Specially at the beginning of the development you shouldn&rsquo;t focus on test coverage, trying to cover every line of code and it is ok to leave some parts out rather than install complicated frameworks that will help you testing weird corner cases. Sometimes tests that way end up being a heavy luggage. As long as the testing framework is in place and you have an easy system to add new tests and you are covering the main logical branches of your code you are ready to take off.</p><p>Enough about tests for now, we will meet them again in a later section dedicated just for them.</p><h2 id=the-type-checker-the-formatter-and-the-linter>The type checker, the formatter and the linter</h2><p>Python is showing it&rsquo;s age and doesn&rsquo;t have many of the features that are now taken for granted in more modern languages. In particular it doesn&rsquo;t have types, meaning it&rsquo;s very easy to call a function with incorrect types, for example. Because of this there is a growth in tools that intend to patch the issues in different ways. Picking a particular set of tools and configuring them correctly might be overwhelming.</p><p>What I describe here is just one selection, as long as you are checking types, adhering to a style guide and having a code formatter.</p><p>We will use <a href=https://microsoft.github.io/pyright/#/>pyright</a> by Microsoft for the type checker. There are many other options, <a href=https://www.mypy-lang.org/>mypy</a> is the reference type checker but mymy seems to be having many issues with Django.</p><p>We will use <a href=https://github.com/psf/black>black</a> for our code formatter and <a href=https://flake8.pycqa.org/en/latest/>flake8</a> to enforce a style guide. We will also use <a href=https://pycqa.github.io/isort/>isort</a> to order our imports consistently.</p><p>You will need to run this tools every time you commit code to the repository and make sure that code is conformant.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>(venv) $ pip install pyright
</span></span><span class=line><span class=cl>(venv) $ pip install black
</span></span><span class=line><span class=cl>(venv) $ pip install flake8
</span></span><span class=line><span class=cl>(evnv) $ pip install isort
</span></span></code></pre></div><p>I leave the configuration options and settings for you, but you can find ours in <a href=https://github.com/nhatcher/users-template/blob/main/.flake8>.flake8</a> and <a href=https://github.com/nhatcher/users-template/blob/main/pyproject.toml>pyproject.toml</a>. Note that you need to run isort in the black compatibility mode.</p><h2 id=tests-test-runner-test-coverage-and-github-actions>Tests, test runner, test coverage and GitHub actions</h2><p>We will use <a href=https://docs.pytest.org/>pytest</a> and <a href=https://pypi.org/project/pytest-cov/>pytest-cov</a>. To install this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>(venv) $ pip install pytest
</span></span><span class=line><span class=cl>(venv) $ pip install pytest-django
</span></span><span class=line><span class=cl>(venv) $ pip install pytest-cov
</span></span></code></pre></div><p>This is a nicer way to run the tests than running <code>python manage.py test</code> for a number of reasons, richer test discovery, more concise syntax, you can do parametrized testing, parallel test execution, custom test makers and use plugins like the coverage tool we will be using.</p><p>Running:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>(venv) $ pytest --cov-report term-missing --cov server
</span></span></code></pre></div><p>Will run all your tests, run a test coverage and tell you which lines are not yet covered.</p><p>This is the important bit, all test need to pass before merging more work into the main branch. This includes not only the Django tests but also the type checker, formatter and linters. I have put all of them in the <a href=https://github.com/nhatcher/users-template/blob/main/run_tests.sh>run_test.sh</a> executable.</p><h2 id=logs-alerts-notifications-and-stats>Logs, alerts, notifications and stats</h2><p>Logs are messages emitted by the application or the operative system that can help us trace back errors or issues that happened through an event or series of events.
It can be informative, signal a warning or be worrisome errors.</p><p>Alerts are messages that we receive in our phones. We probably need to act on them. They signal a house on fire event.
Notifications are also messages that we receive in our movil devices that are just for our information, for example new accounts created.</p><p>Some logs may be updated to alerts or notifications depending on their importance.</p><p>Stats are numbers of certain occurrences that we feel are important. Like number of accounts created or the number of times people logged in into the system.</p><h2 id=deployment-if-the-repository-is-private>Deployment if the repository is private</h2><p>We will need to use <a href=https://docs.github.com/en/authentication/connecting-to-github-with-ssh/managing-deploy-keys#deploy-keys>Deploy keys</a></p><h2 id=refinements>Refinements:</h2><ol>
<li>Cron jobs:</li></ol><ul>
<li>Clean database</li></ul><ol start=2>
<li>
<p>unattended updates. Caddy updates</p></li><li>
<p>Vaults and secrets. Terraform vault.</p></li><li>
<p>Staging server(s)
You might want to have a staging server in <a href=https://staging.example.com>https://staging.example.com</a>. If you want to be safer you can do it using random subdomains: <a href=https://sleigh_year.g.example.com>https://sleigh_year.g.example.com</a>. You can copy the data from production. Droplets are cheap for a few hours or days.</p></li><li>
<p>Creating mock data</p></li></ol><p>When testing the app it is very useful to have the app filled mock data. For that we have a script that fills the database and returns a file with users and passwords.</p><ol start=6>
<li>What a second, what is deployed again?</li></ol><p>Having a visible deployed commit id will save you from trouble.</p><h2 id=extra-a-a-vpn-with-wireguard>Extra A: A VPN with Wireguard</h2><h2 id=extra-b-deployments-on-tagging>Extra B: Deployments on tagging</h2><h2 id=extra-c-code-defines-infrastructure>Extra C: Code defines infrastructure.</h2><p>Using Terraform and Puppet</p></div><div class=post-footer>
<div class=info>
</div></div><div id=fb_comments_container>
<h2>comments</h2><script src=https://utteranc.es/client.js repo=nhatcher/nhatcher.github.io issue-term=pathname theme=preferred-color-scheme crossorigin=anonymous async></script>
</div></div></div></div></div><script type=text/javascript src=https://www.nhatcher.com/js/jquery.min.e80d7e6008943348b2c88cd12f10e546083ff6a88f06b4afac7151b78886417e.js integrity="sha256-6A1+YAiUM0iyyIzRLxDlRgg/9qiPBrSvrHFRt4iGQX4=" crossorigin=anonymous></script>
<script type=text/javascript src=https://www.nhatcher.com/js/bundle.min.3ebad6bf39b2e7c2f899d3ed9bc97e8c0c1ead7a1b57472e3387321f673b8077.js integrity="sha256-PrrWvzmy58L4mdPtm8l+jAwerXobV0cuM4cyH2c7gHc=" crossorigin=anonymous></script>
<script type=text/javascript src=https://www.nhatcher.com/js/medium-zoom.min.e1c6918cbaa90022a5612f0bd71c7bf3be6d036614c5729cebfe14f7b91fa4bc.js integrity="sha256-4caRjLqpACKlYS8L1xx7875tA2YUxXKc6/4U97kfpLw=" crossorigin=anonymous></script>
</body></html>