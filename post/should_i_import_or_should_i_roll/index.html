<!doctype html><html dir=ltr lang=en data-theme class="html theme--light"><head>
<title>
Nicolás Hatcher
|
Trigonometric functions in WebAssembly
</title>
<meta charset=utf-8><meta name=generator content="Hugo 0.122.0"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name=author content="Nicolás Hatcher">
<meta name=description content="Software developer by trade, physicist by soul">
<link rel=stylesheet href=/scss/main.min.1147aa5bacb4bce677a0e264073829caedb82fd18ea07a5f1d80521f539d1c45.css integrity="sha256-EUeqW6y0vOZ3oOJkBzgpyu24L9GOoHpfHYBSH1OdHEU=" crossorigin=anonymous type=text/css>
<link rel=stylesheet href=/css/markupHighlight.min.73ccfdf28df555e11009c13c20ced067af3cb021504cba43644c705930428b00.css integrity="sha256-c8z98o31VeEQCcE8IM7QZ688sCFQTLpDZExwWTBCiwA=" crossorigin=anonymous type=text/css>
<link rel=stylesheet href=/fontawesome/css/fontawesome.min.7d272de35b410fb165377550cdf9c4d3a80fbbcc961e111914e4d5c0eaf5729f.css integrity="sha256-fSct41tBD7FlN3VQzfnE06gPu8yWHhEZFOTVwOr1cp8=" crossorigin=anonymous type=text/css>
<link rel=stylesheet href=/fontawesome/css/solid.min.55d8333481b07a08e07cf6f37319753a2b47e99f4c395394c5747b48b495aa9b.css integrity="sha256-VdgzNIGwegjgfPbzcxl1OitH6Z9MOVOUxXR7SLSVqps=" crossorigin=anonymous type=text/css>
<link rel=stylesheet href=/fontawesome/css/regular.min.a7448d02590b43449364b6b5922ed9af5410abb4de4238412a830316dedb850b.css integrity="sha256-p0SNAlkLQ0STZLa1ki7Zr1QQq7TeQjhBKoMDFt7bhQs=" crossorigin=anonymous type=text/css>
<link rel=stylesheet href=/fontawesome/css/brands.min.9ed75a5d670c953fe4df935937674b4646f92674367e9e66eb995bb04e821647.css integrity="sha256-ntdaXWcMlT/k35NZN2dLRkb5JnQ2fp5m65lbsE6CFkc=" crossorigin=anonymous type=text/css>
<link rel="shortcut icon" href=/favicons/favicon.ico type=image/x-icon>
<link rel=apple-touch-icon sizes=180x180 href=/favicons/apple-touch-icon.png>
<link rel=icon type=image/png sizes=32x32 href=/favicons/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=/favicons/favicon-16x16.png>
<link rel=canonical href=https://www.nhatcher.com/post/should_i_import_or_should_i_roll/>
<script type=text/javascript src=/js/anatole-header.min.f9132794301a01ff16550ed66763482bd848f62243d278f5e550229a158bfd32.js integrity="sha256-+RMnlDAaAf8WVQ7WZ2NIK9hI9iJD0nj15VAimhWL/TI=" crossorigin=anonymous></script>
<script type=text/javascript src=/js/anatole-theme-switcher.min.d6d329d93844b162e8bed1e915619625ca91687952177552b9b3e211014a2957.js integrity="sha256-1tMp2ThEsWLovtHpFWGWJcqRaHlSF3VSubPiEQFKKVc=" crossorigin=anonymous></script>
<meta name=twitter:card content="summary"><meta name=twitter:title content="Trigonometric functions in WebAssembly">
<meta name=twitter:description content="All the code in this blog post is available at github.">
<meta property="og:title" content="Trigonometric functions in WebAssembly">
<meta property="og:description" content="All the code in this blog post is available at github.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://www.nhatcher.com/post/should_i_import_or_should_i_roll/"><meta property="article:section" content="post">
<meta property="article:published_time" content="2023-05-19T11:41:55+02:00">
<meta property="article:modified_time" content="2023-05-19T11:41:55+02:00"><meta property="og:site_name" content="I'm Nicolás Hatcher">
<script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","articleSection":"post","name":"Trigonometric functions in WebAssembly","headline":"Trigonometric functions in WebAssembly","alternativeHeadline":"","description":"
      
        All the code in this blog post is available at github.


      


    ","inLanguage":"en","isFamilyFriendly":"true","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/www.nhatcher.com\/post\/should_i_import_or_should_i_roll\/"},"author":{"@type":"Person","name":"Nicolás Hatcher"},"creator":{"@type":"Person","name":"Nicolás Hatcher"},"accountablePerson":{"@type":"Person","name":"Nicolás Hatcher"},"copyrightHolder":{"@type":"Person","name":"Nicolás Hatcher"},"copyrightYear":"2023","dateCreated":"2023-05-19T11:41:55.00Z","datePublished":"2023-05-19T11:41:55.00Z","dateModified":"2023-05-19T11:41:55.00Z","publisher":{"@type":"Organization","name":"Nicolás Hatcher","url":"https://www.nhatcher.com","logo":{"@type":"ImageObject","url":"https:\/\/www.nhatcher.com\/favicons\/favicon-32x32.png","width":"32","height":"32"}},"image":[],"url":"https:\/\/www.nhatcher.com\/post\/should_i_import_or_should_i_roll\/","wordCount":"1014","genre":[],"keywords":["WebAssembly","Rust"]}</script>
</head>
<body class=body>
<div class=wrapper>
<aside class=wrapper__sidebar><div class="sidebar
.">
<div class=sidebar__content>
<div class=sidebar__introduction>
<img class=sidebar__introduction-profileimage src=/images/profile.jpg alt="profile picture">
<div class=sidebar__introduction-title>
<a href=/>I'm Nicolás Hatcher</a>
</div>
<div class=sidebar__introduction-description>
<p>Software developer by trade, physicist by soul</p>
</div>
</div>
<ul class=sidebar__list>
<li class=sidebar__list-item>
<a href="https://arxiv.org/search/?searchtype=author&amp;query=Hatcher%2C+N" target=_blank rel="noopener me" aria-label=Publications title=Publications>
<i class="fas fa-file-alt fa-2x" aria-hidden=true></i>
</a>
</li>
<li class=sidebar__list-item>
<a href=https://github.com/nhatcher/ target=_blank rel="noopener me" aria-label=GitHub title=GitHub>
<i class="fab fa-github fa-2x" aria-hidden=true></i>
</a>
</li>
<li class=sidebar__list-item>
<a href=https://www.instagram.com/theuniverse.today target=_blank rel="noopener me" aria-label=instagram title=instagram>
<i class="fab fa-instagram fa-2x" aria-hidden=true></i>
</a>
</li>
<li class=sidebar__list-item>
<a href=mailto:nicolas@theuniverse.today target=_blank rel="noopener me" aria-label=e-mail title=e-mail>
<i class="fas fa-envelope fa-2x" aria-hidden=true></i>
</a>
</li>
</ul>
</div><footer class="footer footer__sidebar">
<ul class=footer__list>
<li class=footer__item>
&copy;
Nicolás Hatcher
2024
</li>
</ul>
</footer>
<script type=text/javascript src=/js/medium-zoom.min.1248fa75275e5ef0cbef27e8c1e27dc507c445ae3a2c7d2ed0be0809555dac64.js integrity="sha256-Ekj6dSdeXvDL7yfoweJ9xQfERa46LH0u0L4ICVVdrGQ=" crossorigin=anonymous></script></div>
</aside>
<main class=wrapper__main>
<header class=header><div class=.>
<a role=button class=navbar-burger data-target=navMenu aria-label=menu aria-expanded=false>
<span aria-hidden=true class=navbar-burger__line></span>
<span aria-hidden=true class=navbar-burger__line></span>
<span aria-hidden=true class=navbar-burger__line></span>
</a>
<nav class=nav>
<ul class=nav__list id=navMenu>
<li class=nav__list-item>
<a href=/ title>Home</a>
</li>
<li class=nav__list-item>
<a href=/post/ title>Posts</a>
</li>
<li class=nav__list-item>
<a href=/about/ title>About</a>
</li>
</ul>
<ul class="nav__list nav__list--end">
<li class=nav__list-item>
<div class=themeswitch>
<a title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i>
</a>
</div>
</li>
</ul>
</nav>
</div>
</header>
<div class="post
.">
<div class=post__content>
<h1>Trigonometric Functions in WebAssembly</h1>
<ul class=post__meta>
<li class=post__meta-item>
<em class="fas fa-calendar-day post__meta-icon"></em>
<span class=post__meta-text>
Fri, May 19, 2023
</span>
</li>
<li class=post__meta-item>
<em class="fas fa-stopwatch post__meta-icon"></em>
<span class=post__meta-text>5-minute read</span>
</li>
</ul>
<p>All the code in this blog post is available at <a href=https://github.com/nhatcher/import_or_roll>github</a>. I also setup a site to make some tests of your own in the <a href=https://www.nhatcher.com/import_or_roll/>github pages</a>.</p>
<p>When computing elementary transcendental functions in WebAssembly (like trigonometric functions) we have two options, we can either import the functions for the runtime or roll our own.</p>
<p>The second option doesn&rsquo;t really mean that we have two write our own implementation but that we can use the <code>libc</code> or whatever implementation we have from our standard library.</p>
<p>As we shall see we probably want to import and use the implementation from the host runtime, in our case the browser, and not the one given by our standard library. This is good news because it means we need to ship less code <em>and</em> be more performant.</p>
<p>Think about the following problem, how many integer numbers <code>x</code> in <code>[0, N]</code> are such that <code>sin(x) &lt; T</code>?</p>
<p>A simple JavaScript function would look like:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kd>function</span> <span class=nx>count_numbers</span><span class=p>(</span><span class=nx>N</span><span class=p>,</span> <span class=nx>T</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>count</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>N</span><span class=p>;</span> <span class=nx>i</span> <span class=o>+=</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nb>Math</span><span class=p>.</span><span class=nx>sin</span><span class=p>(</span><span class=nx>i</span><span class=p>)</span> <span class=o>&lt;</span> <span class=nx>T</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>count</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>count</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>For instance: <code>count_numbers(100_000_000, 0.223) => 57_158_497</code>. In C:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// gcc -o test tets.c -O3 -lm
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;math.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>count_numbers</span><span class=p>(</span><span class=kt>double</span> <span class=n>N</span><span class=p>,</span> <span class=kt>double</span> <span class=n>T</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>count</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>double</span> <span class=n>i</span> <span class=o>=</span> <span class=mf>0.0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>N</span><span class=p>;</span> <span class=n>i</span> <span class=o>+=</span> <span class=mf>1.0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nf>sin</span><span class=p>(</span><span class=n>i</span><span class=p>)</span> <span class=o>&lt;</span> <span class=n>T</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>count</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>count</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>count</span> <span class=o>=</span> <span class=nf>count_numbers</span><span class=p>(</span><span class=mf>100000000.0</span><span class=p>,</span> <span class=mf>0.223</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;%i&#34;</span><span class=p>,</span> <span class=n>count</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Now let&rsquo;s run this in WebAssembly. Let&rsquo;s use Rust first. Create a project like:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ cargo new --lib test_wasm
</span></span></code></pre></div><p>Modify <code>cargo.toml</code> to contain the <code>crate-type = ["cdylib"]</code> lib:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=p>[</span><span class=nx>package</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>name</span> <span class=p>=</span> <span class=s2>&#34;test_wasm&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>version</span> <span class=p>=</span> <span class=s2>&#34;0.1.0&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>edition</span> <span class=p>=</span> <span class=s2>&#34;2021&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nx>dependencies</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nx>lib</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>crate-type</span> <span class=p>=</span> <span class=p>[</span><span class=s2>&#34;cdylib&#34;</span><span class=p>]</span>
</span></span></code></pre></div><p>In <code>lib.rs</code> you will need:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-Rust data-lang=Rust><span class=line><span class=cl><span class=cp>#[link(wasm_import_module = </span><span class=s>&#34;Math&#34;</span><span class=cp>)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>extern</span><span class=w> </span><span class=s>&#34;C&#34;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>sin</span><span class=p>(</span><span class=n>x</span>: <span class=kt>f64</span><span class=p>)</span><span class=w> </span>-&gt; <span class=kt>f64</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[no_mangle]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>count_js_import</span><span class=p>(</span><span class=n>n</span>: <span class=kt>f64</span><span class=p>,</span><span class=w> </span><span class=n>x</span>: <span class=kt>f64</span><span class=p>)</span><span class=w> </span>-&gt; <span class=kt>i32</span> <span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>i</span>: <span class=kt>f64</span> <span class=o>=</span><span class=w> </span><span class=mf>0.0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=k>unsafe</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>sin</span><span class=p>(</span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>count</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>i</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mf>1.0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>count</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[no_mangle]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>count_rust</span><span class=p>(</span><span class=n>n</span>: <span class=kt>f64</span><span class=p>,</span><span class=w> </span><span class=n>x</span>: <span class=kt>f64</span><span class=p>)</span><span class=w> </span>-&gt; <span class=kt>i32</span> <span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>i</span>: <span class=kt>f64</span> <span class=o>=</span><span class=w> </span><span class=mf>0.0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=kt>f64</span>::<span class=n>sin</span><span class=p>(</span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>count</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>i</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mf>1.0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>count</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>The <code>#[no_mangle]</code> macros just ensure the functions are properly exported. The first lines import a function <code>Math.sin</code> from the host environment.</p>
<p>To compile it to WebAssembly run:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ cargo build --release --target wasm32-unknown-unknown
</span></span></code></pre></div><p>The <code>wasm</code> compiled file will be at: <code>target/wasm32-unknown-unknown/release/test_wasm.wasm</code>. Note that wasm files produced by the Rust compiler are normally very large. You may want to remove the garbage running:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ wasm-gc test_wasm.wasm
</span></span></code></pre></div><p>Get that file in the same folder with the driver program:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=cp>&lt;!DOCTYPE html&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>html</span> <span class=na>lang</span><span class=o>=</span><span class=s>&#34;en&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>meta</span> <span class=na>charset</span><span class=o>=</span><span class=s>&#34;UTF-8&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>meta</span> <span class=na>http-equiv</span><span class=o>=</span><span class=s>&#34;X-UA-Compatible&#34;</span> <span class=na>content</span><span class=o>=</span><span class=s>&#34;IE=edge&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>meta</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;viewport&#34;</span> <span class=na>content</span><span class=o>=</span><span class=s>&#34;width=300, initial-scale=1.0&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>title</span><span class=p>&gt;</span>Should I import or should I roll?<span class=p>&lt;/</span><span class=nt>title</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=kd>function</span> <span class=nx>count_numbers</span><span class=p>(</span><span class=nx>n</span><span class=p>,</span> <span class=nx>t</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kd>let</span> <span class=nx>count</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>x</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>x</span> <span class=o>&lt;</span> <span class=nx>t</span><span class=p>;</span> <span class=nx>x</span> <span class=o>+=</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=nb>Math</span><span class=p>.</span><span class=nx>sin</span><span class=p>(</span><span class=nx>x</span><span class=p>)</span> <span class=o>&lt;</span> <span class=nx>t</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nx>count</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=nx>count</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>N</span> <span class=o>=</span> <span class=mi>100_000_000</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>T</span> <span class=o>=</span> <span class=mf>0.223</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nx>WebAssembly</span><span class=p>.</span><span class=nx>instantiateStreaming</span><span class=p>(</span><span class=nx>fetch</span><span class=p>(</span><span class=s2>&#34;main.wasm&#34;</span><span class=p>),</span> <span class=p>{</span> <span class=nb>Math</span> <span class=p>}).</span><span class=nx>then</span><span class=p>((</span><span class=nx>obj</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kr>const</span> <span class=p>{</span><span class=nx>count_rust_roll</span><span class=p>,</span> <span class=nx>count_js_import</span><span class=p>}</span> <span class=o>=</span> <span class=nx>obj</span><span class=p>.</span><span class=nx>instance</span><span class=p>.</span><span class=nx>exports</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=nx>console</span><span class=p>.</span><span class=nx>time</span><span class=p>(</span><span class=s1>&#39;count_numbers&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>count_numbers</span><span class=p>(</span><span class=nx>N</span><span class=p>,</span> <span class=nx>T</span><span class=p>));</span>
</span></span><span class=line><span class=cl>            <span class=nx>console</span><span class=p>.</span><span class=nx>timeEnd</span><span class=p>(</span><span class=s1>&#39;count_numbers&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=nx>console</span><span class=p>.</span><span class=nx>time</span><span class=p>(</span><span class=s1>&#39;count_js_import&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>count_js_import</span><span class=p>(</span><span class=nx>N</span><span class=p>,</span> <span class=nx>T</span><span class=p>));</span>
</span></span><span class=line><span class=cl>            <span class=nx>console</span><span class=p>.</span><span class=nx>timeEnd</span><span class=p>(</span><span class=s1>&#39;count_js_import&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=nx>console</span><span class=p>.</span><span class=nx>time</span><span class=p>(</span><span class=s1>&#39;count_rust_roll&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>count_rust_roll</span><span class=p>(</span><span class=nx>N</span><span class=p>,</span> <span class=nx>T</span><span class=p>));</span>
</span></span><span class=line><span class=cl>            <span class=nx>console</span><span class=p>.</span><span class=nx>timeEnd</span><span class=p>(</span><span class=s1>&#39;count_rust_roll&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span></code></pre></div><p>Finally run a local server, for instance:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ python -m http.server
</span></span></code></pre></div><p>A version of that be found in my <a href=https://www.nhatcher.com/import_or_roll/>github pages</a>.</p>
<h2 id=some-numbers>Some numbers</h2>
<p>As we see on the table bellow, rolling our own version of <code>sin</code> (or using one from the standard library) is somewhat slower, so we should definitely import.</p>
<p>We don&rsquo;t need to make a proper benchmark here to make a decision. Rolling your own implementation of <code>sin</code> is worse than using the browser&rsquo;s implementation:</p>
<table>
<thead>
<tr>
<th></th>
<th style=text-align:center>N=100_000</th>
<th style=text-align:center>N=10_000_000</th>
<th style=text-align:center>N=100_000_000</th>
</tr>
</thead>
<tbody>
<tr>
<td>JavaScript</td>
<td style=text-align:center>0.048</td>
<td style=text-align:center>0.173</td>
<td style=text-align:center>1.374</td>
</tr>
<tr>
<td>C Metal</td>
<td style=text-align:center>0.020</td>
<td style=text-align:center>0.130</td>
<td style=text-align:center>1.100</td>
</tr>
<tr>
<td>Rust Metal</td>
<td style=text-align:center>0.020</td>
<td style=text-align:center>0.130</td>
<td style=text-align:center>1.100</td>
</tr>
<tr>
<td>Wasm Import</td>
<td style=text-align:center>0.019</td>
<td style=text-align:center>0.163</td>
<td style=text-align:center>1.633</td>
</tr>
<tr>
<td>Wasm Roll</td>
<td style=text-align:center>0.048</td>
<td style=text-align:center>1.362</td>
<td style=text-align:center>16.146</td>
</tr>
</tbody>
</table>
<p>Again, this is not a benchmark, so don&rsquo;t read too much into &ldquo;pure javascript being faster than WebAssembly&rdquo;. This may well true in this particular case because the js engine is able to compile the function into assembly code on the spot (that is a JIT, Jut In Time compiler). That said you might want to run this in Chrome or Firefox or even your phone and see some differences.</p>
<p>The only takeaway here is that folks targeting WebAssembly in the browser should use the browser&rsquo;s <code>Math.sin</code> and not use your language&rsquo;s implementation.</p>
<p>Thanks mainly it! Thanks for reading.</p>
<h2 id=lets-also-do-it-with-c>Let&rsquo;s also do it with C</h2>
<p>Just because it is fun, let&rsquo;s do the same thing in C.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// clang --target=wasm32 --no-standard-libraries -Wl,--export-all -Wl,--no-entry -o main.wasm main.c
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nf>__attribute__</span><span class=p>((</span><span class=nf>import_module</span><span class=p>(</span><span class=s>&#34;Math&#34;</span><span class=p>),</span> <span class=nf>import_name</span><span class=p>(</span><span class=s>&#34;sin&#34;</span><span class=p>)))</span>
</span></span><span class=line><span class=cl><span class=kt>double</span> <span class=nf>Sin</span><span class=p>(</span><span class=kt>double</span> <span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>__attribute__</span><span class=p>((</span><span class=nf>visibility</span><span class=p>(</span><span class=s>&#34;default&#34;</span><span class=p>)))</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>count_numbers</span><span class=p>(</span><span class=kt>double</span> <span class=n>N</span><span class=p>,</span> <span class=kt>double</span> <span class=n>T</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>count</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>double</span> <span class=n>i</span> <span class=o>=</span> <span class=mf>0.0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>N</span><span class=p>;</span> <span class=n>i</span> <span class=o>+=</span> <span class=mf>1.0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nf>Sin</span><span class=p>(</span><span class=n>i</span><span class=p>)</span> <span class=o>&lt;</span> <span class=n>T</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>count</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>count</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The two <em>attributes</em> are a way to tell the clang compiler to export the function <code>count_numbers</code> and to import the function <code>Math.sin</code> as <code>Sin</code>. See, for instance (Se, for instance, (<a href=https://clang.llvm.org/docs/AttributeReference.html#import-module>https://clang.llvm.org/docs/AttributeReference.html#import-module</a>))</p>
<p>To compile it we can use (clang can compile directly to wasm we do not need emscripten):</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl> $ clang --target<span class=o>=</span>wasm32 --no-standard-libraries -Wl,--export-all -Wl,--no-entry -o main.wasm main.c
</span></span></code></pre></div><p>To run and test the code:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=cp>&lt;!DOCTYPE html&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>html</span> <span class=na>lang</span><span class=o>=</span><span class=s>&#34;en&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>meta</span> <span class=na>charset</span><span class=o>=</span><span class=s>&#34;UTF-8&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>meta</span> <span class=na>http-equiv</span><span class=o>=</span><span class=s>&#34;X-UA-Compatible&#34;</span> <span class=na>content</span><span class=o>=</span><span class=s>&#34;IE=edge&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>meta</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;viewport&#34;</span> <span class=na>content</span><span class=o>=</span><span class=s>&#34;width=300, initial-scale=1.0&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>title</span><span class=p>&gt;</span>Testing WebAssembly<span class=p>&lt;/</span><span class=nt>title</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nx>WebAssembly</span><span class=p>.</span><span class=nx>instantiateStreaming</span><span class=p>(</span><span class=nx>fetch</span><span class=p>(</span><span class=s2>&#34;main.wasm&#34;</span><span class=p>),</span> <span class=p>{</span> <span class=nb>Math</span> <span class=p>}).</span><span class=nx>then</span><span class=p>((</span><span class=nx>obj</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>console</span><span class=p>.</span><span class=nx>time</span><span class=p>(</span><span class=s1>&#39;compute&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>obj</span><span class=p>.</span><span class=nx>instance</span><span class=p>.</span><span class=nx>exports</span><span class=p>.</span><span class=nx>count_numbers</span><span class=p>(</span><span class=mi>100_000_000</span><span class=p>,</span> <span class=mf>0.223</span><span class=p>));</span>
</span></span><span class=line><span class=cl>            <span class=nx>console</span><span class=p>.</span><span class=nx>timeEnd</span><span class=p>(</span><span class=s1>&#39;compute&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span></code></pre></div><h2 id=exercises>Exercises</h2>
<ol>
<li>Does importing a function from the host environment incur in a performance penalty? The answer is no, you can do a similar test we did with the function <code>sin</code> with the function <code>abs</code>. Go ahead and do that!</li>
<li>Use emscripten to compile a C file that uses the C implementation for sin, maybe emscripten is smart enough, I have not tried myself!. Maybe you want to use <code>[musl libc](https://musl.libc.org/)</code></li>
<li>Roll your own implementation of <code>sin</code> using Taylor series or any other approximation you think it is reasonable. What happens?</li>
</ol>
</div>
<div class=post__footer>
<span><a class=tag href=/tags/webassembly/>WebAssembly</a><a class=tag href=/tags/rust/>Rust</a></span>
</div>
</div>
</main>
</div><footer class="footer footer__base">
<ul class=footer__list>
<li class=footer__item>
&copy;
Nicolás Hatcher
2024
</li>
</ul>
</footer>
<script type=text/javascript src=/js/medium-zoom.min.1248fa75275e5ef0cbef27e8c1e27dc507c445ae3a2c7d2ed0be0809555dac64.js integrity="sha256-Ekj6dSdeXvDL7yfoweJ9xQfERa46LH0u0L4ICVVdrGQ=" crossorigin=anonymous></script></body>
</html>